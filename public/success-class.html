<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Success Class Translator</title>
  
  <!-- Supabase SDK -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root {
      --bg-app: #000000;
      --bg-panel: #121212;
      --bg-card: #1e1e1e;
      --bg-input: #111;
      --text-main: #e0e0e0;
      --text-muted: #888888;
      --accent-orange: #f59e0b;
      --accent-green: #10b981;
      --accent-red: #ef4444;
      --border: #333;
      --radius: 16px;
      --font: "SF Pro Text", "SF Pro Display", -apple-system, BlinkMacSystemFont, "Helvetica Neue", "Segoe UI", system-ui, sans-serif;
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

    body {
      margin: 0;
      background: var(--bg-app);
      color: var(--text-main);
      font-family: var(--font);
      height: 100vh;
      overflow: hidden;
      display: flex;
      justify-content: center;
    }

    /* === WELCOME MODAL === */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.6);
      -webkit-backdrop-filter: blur(16px);
      backdrop-filter: blur(16px);
      z-index: 9999;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 1;
      transition: opacity 0.5s ease, visibility 0.5s;
    }
    
    .modal-overlay.hidden {
      opacity: 0;
      visibility: hidden;
      pointer-events: none;
    }

    .modal-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      padding: 40px 30px;
      border-radius: 24px;
      text-align: center;
      max-width: 90%;
      width: 360px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.8);
      transform: scale(1);
      transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }
    
    .modal-overlay.hidden .modal-card {
      transform: scale(0.9);
    }

    .modal-icon {
      width: 64px; height: 64px;
      background: linear-gradient(135deg, var(--accent-orange), #d97706);
      border-radius: 16px;
      margin: 0 auto 20px auto;
      display: flex; align-items: center; justify-content: center;
      box-shadow: 0 10px 30px rgba(245, 158, 11, 0.3);
    }
    
    .modal-title { font-size: 22px; font-weight: 700; color: #fff; margin-bottom: 8px; }
    .modal-desc { font-size: 14px; color: var(--text-muted); line-height: 1.5; margin-bottom: 30px; }

    .btn-large {
      width: 100%;
      padding: 16px;
      background: var(--accent-green);
      color: white;
      border: none;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 700;
      cursor: pointer;
      transition: transform 0.1s;
      box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
    }
    .btn-large:active { transform: scale(0.98); }

    /* === MAIN APP === */
    .app-container {
      width: 100%;
      max-width: 500px;
      background: var(--bg-panel);
      display: flex;
      flex-direction: column;
      height: 100%;
      position: relative;
      box-shadow: 0 0 40px rgba(0,0,0,0.5);
    }

    @media (min-width: 501px) {
      body { align-items: center; padding: 20px; }
      .app-container { height: 90vh; border-radius: var(--radius); border: 1px solid var(--border); }
    }

    .header {
      padding: 16px 20px;
      border-bottom: 1px solid var(--border);
      background: var(--bg-panel);
      z-index: 20;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    
    .header-top { display: flex; justify-content: space-between; align-items: center; }
    .header h1 { margin: 0; font-size: 17px; font-weight: 700; letter-spacing: -0.5px; }
    .header p { margin: 2px 0 0 0; font-size: 11px; color: var(--text-muted); }

    .auth-bar {
      display: flex; gap: 8px; background: #252525; padding: 6px;
      border-radius: 10px; border: 1px solid #333;
      min-height: 46px;
    }

    .auth-input-group { flex: 1; display: none; position: relative; }

    .auth-input {
      width: 100%; background: #111; border: 1px solid #444; color: #fff;
      padding: 8px 10px; border-radius: 6px 0 0 6px; font-size: 13px;
      outline: none; font-family: monospace; text-transform: uppercase;
    }
    .auth-input:focus { border-color: var(--accent-orange); }

    .btn-join {
      background: var(--accent-green); color: white; border: none;
      border-radius: 0 6px 6px 0; padding: 0 12px; font-size: 12px;
      font-weight: 700; cursor: pointer; text-transform: uppercase;
    }

    .my-id-container {
      display: flex; align-items: center; gap: 6px; padding: 0 12px;
      background: rgba(245, 158, 11, 0.1); border: 1px solid rgba(245, 158, 11, 0.3);
      border-radius: 6px; cursor: pointer; width: 100%; justify-content: space-between;
      transition: background 0.2s;
    }
    .my-id-container:active { background: rgba(245, 158, 11, 0.3); transform: scale(0.98); }
    
    .my-id-label { font-size: 9px; color: var(--accent-orange); font-weight: 600; text-transform: uppercase; }
    .my-id-val { font-size: 14px; color: #fff; font-family: monospace; font-weight: 700; letter-spacing: 1px; }

    /* Connected Badge (for embed mode) */
    .connected-badge {
      display: none; align-items: center; gap: 6px; padding: 8px 12px;
      background: rgba(16, 185, 129, 0.1); border: 1px solid rgba(16, 185, 129, 0.3);
      border-radius: 6px; width: 100%;
    }
    .connected-badge .dot { background: var(--accent-green); box-shadow: 0 0 8px var(--accent-green); }
    .connected-badge span { color: var(--accent-green); font-size: 12px; font-weight: 600; }

    .tabs { display: flex; background: var(--bg-panel); border-bottom: 1px solid var(--border); flex-shrink: 0; z-index: 15; }
    .tab-btn {
      flex: 1; background: transparent; border: none; color: var(--text-muted);
      padding: 16px; font-size: 13px; font-weight: 600; cursor: pointer;
      text-transform: uppercase; letter-spacing: 1px; border-bottom: 3px solid transparent;
      transition: all 0.2s;
    }
    .tab-btn.active {
      color: var(--accent-orange); border-bottom-color: var(--accent-orange);
      background: rgba(245, 158, 11, 0.05);
    }

    .tab-content {
      flex: 1; overflow-y: auto; overflow-x: hidden; padding: 16px;
      display: none; flex-direction: column; gap: 16px; padding-bottom: 80px; 
    }
    .tab-content.active { display: flex; }

    .card { background: var(--bg-card); border-radius: 12px; padding: 16px; border: 1px solid #2a2a2a; }
    .card-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
    .card-label {
      font-size: 11px; color: var(--text-muted); text-transform: uppercase;
      letter-spacing: 0.8px; font-weight: 600; margin-bottom: 8px; display: block;
    }

    .status-badge { display: flex; align-items: center; gap: 10px; font-size: 14px; font-weight: 500; }
    .dot { width: 8px; height: 8px; border-radius: 50%; background: #444; transition: 0.3s; }
    .dot.active { background: var(--accent-green); box-shadow: 0 0 10px var(--accent-green); }
    .dot.receiving { background: var(--accent-orange); box-shadow: 0 0 10px var(--accent-orange); }

    select {
      width: 100%; background: #111; color: white; border: 1px solid #333; padding: 14px;
      border-radius: 8px; font-size: 15px; outline: none; appearance: none;
      background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23888888%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E");
      background-repeat: no-repeat; background-position: right 14px top 50%; background-size: 10px auto;
    }

    .btn {
      width: 100%; padding: 16px; border-radius: 8px; border: none;
      font-weight: 600; font-size: 15px; cursor: pointer; transition: transform 0.1s;
    }
    .btn:active { transform: scale(0.98); }
    .btn-green { background: var(--accent-green); color: white; }
    .btn-red { background: var(--accent-red); color: white; }
    .btn-outline {
      background: transparent; border: 1px solid #444; color: #888;
      padding: 6px 12px; font-size: 12px; width: auto; border-radius: 6px; cursor: default;
    }

    .switch { position: relative; display: inline-block; width: 46px; height: 26px; }
    .switch input { opacity: 0; width: 0; height: 0; }
    .slider {
      position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
      background-color: #333; border-radius: 34px; transition: .3s;
    }
    .slider:before {
      position: absolute; content: ""; height: 20px; width: 20px; left: 3px; bottom: 3px;
      background-color: #888; border-radius: 50%; transition: .3s;
    }
    input:checked + .slider { background-color: var(--accent-orange); }
    input:checked + .slider:before { transform: translateX(20px); background-color: white; }

    .range-wrap { margin-bottom: 16px; }
    .range-label-row { display: flex; justify-content: space-between; font-size: 12px; margin-bottom: 8px; color: var(--text-muted); }
    input[type=range] { -webkit-appearance: none; appearance: none; width: 100%; background: transparent; }
    input[type=range]::-webkit-slider-thumb {
      -webkit-appearance: none; height: 18px; width: 18px; border-radius: 50%;
      background: var(--accent-orange); cursor: pointer; margin-top: -7px;
      box-shadow: 0 0 10px rgba(245, 158, 11, 0.3);
    }
    input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; cursor: pointer; background: #333; border-radius: 2px;
    }

    .history-box {
      flex: 1; min-height: 100px;
      font-family: monospace; font-size: 13px; color: #aaa;
      display: flex; flex-direction: column; gap: 8px;
    }
    .history-item { padding-bottom: 8px; border-bottom: 1px solid #222; animation: slideIn 0.3s ease; }
    .history-src { color: var(--accent-orange); font-weight: 600; margin-bottom: 2px; }
    .history-tgt { color: var(--text-main); }

    @keyframes slideIn { from { opacity: 0; transform: translateX(-10px); } to { opacity: 1; transform: translateX(0); } }

    .live-caption-bar {
      position: absolute; bottom: 0; left: 0; right: 0;
      background: rgba(18, 18, 18, 0.95);
      border-top: 1px solid var(--border);
      padding: 16px;
      min-height: 60px;
      display: flex; align-items: center; justify-content: center;
      text-align: center; font-size: 15px; color: var(--accent-orange);
      font-weight: 500; line-height: 1.4;
      -webkit-backdrop-filter: blur(8px);
      backdrop-filter: blur(8px);
      z-index: 100;
    }

    .viz-canvas { width: 100%; height: 48px; background: #111; border-radius: 8px; margin-top: 12px; display: block; }

    /* TOAST NOTIFICATION */
    .toast {
      position: absolute; top: 120px; left: 50%; transform: translateX(-50%) translateY(20px);
      background: var(--accent-green); color: white; padding: 10px 24px;
      border-radius: 30px; font-size: 13px; font-weight: 600; opacity: 0;
      pointer-events: none; transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); 
      z-index: 2000; box-shadow: 0 8px 20px rgba(0,0,0,0.4);
      display: flex; align-items: center; gap: 8px;
    }
    .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

    ::-webkit-scrollbar { width: 4px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: #333; border-radius: 2px; }

    /* === EMBED MODE OVERRIDES === */
    body.embed-mode { padding: 0; }
    body.embed-mode .modal-overlay { display: none !important; }
    body.embed-mode .header { padding: 12px 16px; }
    body.embed-mode .header h1 { font-size: 15px; }
    body.embed-mode .app-container { 
      max-width: 100%; 
      height: 100vh; 
      border-radius: 0; 
      border: none;
    }
  </style>
</head>

<body>

<!-- Welcome Modal -->
<div id="welcomeModal" class="modal-overlay">
  <div class="modal-card">
    <div class="modal-icon">
      <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
        <path d="M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3Z"></path>
        <path d="M19 10v2a7 7 0 0 1-14 0v-2"></path>
        <line x1="12" y1="19" x2="12" y2="23"></line>
        <line x1="8" y1="23" x2="16" y2="23"></line>
      </svg>
    </div>
    <div class="modal-title">Welcome to Orbit</div>
    <div class="modal-desc">
      Your real-time AI translation companion. <br>
      Create an instant classroom or event session.
    </div>
    <button id="getStartedBtn" class="btn-large">Get Started</button>
  </div>
</div>

<audio id="tts" autoplay></audio>

<!-- Toast Message -->
<div id="toast" class="toast">
  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>
  Copied Successfully!
</div>

<div class="app-container">
  
  <div class="header">
    <div class="header-top">
      <div>
        <h1>Success Class Translator</h1>
        <p>Supabase Powered â€¢ Real-time</p>
      </div>
    </div>

    <!-- Auth / Room Bar -->
    <div class="auth-bar">
      <!-- JOIN INPUT (Shown in Receiver Tab) -->
      <div id="authInputGroup" class="auth-input-group">
        <input type="text" id="joinInput" class="auth-input" placeholder="ENTER CLASS ID" maxlength="6">
        <button id="joinBtn" class="btn-join">JOIN</button>
      </div>
      
      <!-- MY CLASS ID (Shown in Source Tab) -->
      <div id="myIdGroup" class="my-id-container" title="Copy My Class ID">
        <span class="my-id-label">MY CLASS ID</span>
        <div style="display:flex; align-items:center; gap:8px;">
          <span id="myClassId" class="my-id-val">...</span>
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#f59e0b" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
            <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
          </svg>
        </div>
      </div>

      <!-- Connected Badge (Embed Mode) -->
      <div id="connectedBadge" class="connected-badge">
        <span class="dot active"></span>
        <span>CONNECTED: <strong id="connectedRoomId"></strong></span>
      </div>
    </div>
  </div>

  <!-- Standard Click Handlers -->
  <div class="tabs">
    <button class="tab-btn active" id="btn-source">Source (Mic)</button>
    <button class="tab-btn" id="btn-receiver">Receiver (Speaker)</button>
  </div>

  <!-- SOURCE TAB -->
  <div id="tab-source" class="tab-content active">
    
    <div class="card">
      <div class="card-label">Broadcaster Status</div>
      <div class="card-row">
        <div class="status-badge">
          <span id="floorDot" class="dot"></span>
          <span id="floorText">Mic Off</span>
        </div>
        <button class="btn-outline">Admin</button>
      </div>
      <canvas id="sourceViz" class="viz-canvas" width="400" height="60"></canvas>
    </div>

    <div>
      <label class="card-label">My Language (Speaking)</label>
      <select id="srcLang" title="Select source language"></select>
    </div>

    <div>
      <label class="card-label">Microphone Input</label>
      <select id="micSelect" title="Select microphone input">
        <option value="default">Default Microphone</option>
      </select>
      <div style="font-size:11px; color:#555; margin-top:6px;">Feeds transcription engine</div>
    </div>

    <div style="margin-top: auto;">
      <button id="broadcastBtn" class="btn btn-green">Start Broadcasting</button>
    </div>

  </div>

  <!-- RECEIVER TAB -->
  <div id="tab-receiver" class="tab-content">
    
    <div class="card">
      <div class="status-badge" style="margin-bottom:10px;">
        <span id="recvDot" class="dot"></span>
        <span id="recvText">Waiting for audio...</span>
      </div>
      <canvas id="recvViz" class="viz-canvas" width="400" height="60"></canvas>
    </div>

    <div class="card card-row">
      <div>
        <div style="font-weight:600; font-size:14px; color:#fff;">Enable Audio</div>
        <div style="font-size:11px; color:#666;">Play translations via TTS</div>
      </div>
      <label class="switch">
        <input type="checkbox" id="recvToggle" checked>
        <span class="slider"></span>
      </label>
    </div>

    <button id="testTTSBtn" class="btn" style="background:#333; border:1px solid #555; margin-bottom:16px;">ðŸ”Š Test TTS Audio</button>

    <div>
      <label class="card-label">Translation Language</label>
      <select id="tgtLang" title="Select translation language"></select>
    </div>

    <div>
      <label class="card-label">Speaker Output</label>
      <select id="speakerSelect" title="Select speaker output">
        <option value="default">Default Speaker</option>
      </select>
      <div style="font-size:11px; color:#555; margin-top:6px;">Route TTS to headphones/speakers</div>
    </div>

    <div class="card">
      <div class="card-label" style="margin-bottom:12px;">AI Voice Controls</div>
      <div class="range-wrap">
        <div class="range-label-row"><span>Speed</span><span id="speedVal">1.0x</span></div>
        <input type="range" id="speedRange" min="0.5" max="2.0" step="0.1" value="1.0">
      </div>
      <div class="range-wrap" style="margin-bottom:0;">
        <div class="range-label-row"><span>Volume</span><span id="volVal">1.0x</span></div>
        <input type="range" id="volRange" min="0.0" max="1.0" step="0.1" value="1.0">
      </div>
    </div>

    <div style="margin-bottom: 20px;">
      <label class="card-label">Transcript History</label>
      <div id="historyBox" class="history-box">
        <div style="text-align:center; padding-top:20px; font-style:italic; opacity:0.5;">No history yet</div>
      </div>
    </div>

  </div>

  <div id="liveCaptionBar" class="live-caption-bar"></div>

</div>

<!-- EMBED MODE DETECTION -->
<script>
(function() {
    const urlParams = new URLSearchParams(window.location.search);
    const isEmbed = urlParams.get('embed') === 'true';
    const embedRoom = urlParams.get('roomName');
    
    if (isEmbed) {
        document.body.classList.add('embed-mode');
        document.getElementById('welcomeModal').classList.add('hidden');
        
        if (embedRoom) {
            window.AUTO_JOIN_ROOM = embedRoom;
            // Show connected badge instead of ID input
            document.getElementById('connectedRoomId').textContent = embedRoom.toUpperCase();
            document.getElementById('connectedBadge').style.display = 'flex';
            document.getElementById('myIdGroup').style.display = 'none';
            document.getElementById('authInputGroup').style.display = 'none';
        }
    }
})();
</script>

<!-- STANDARD JS -->
<script>
    /* 1. INSTANT ID GENERATION */
    function generateId() {
        return Math.random().toString(36).substring(2, 8).toUpperCase();
    }
    if (!window.AUTO_JOIN_ROOM) {
        const localId = generateId();
        document.getElementById('myClassId').textContent = localId;
    }

    /* 2. TAB SWITCHING LOGIC (Shows/Hides ID inputs) */
    const btnSource = document.getElementById('btn-source');
    const btnReceiver = document.getElementById('btn-receiver');
    const tabSource = document.getElementById('tab-source');
    const tabReceiver = document.getElementById('tab-receiver');
    const authInputGroup = document.getElementById('authInputGroup');
    const myIdGroup = document.getElementById('myIdGroup');

    function switchTab(target) {
        if(target === 'source') {
            btnSource.classList.add('active');
            btnReceiver.classList.remove('active');
            tabSource.classList.add('active');
            tabReceiver.classList.remove('active');
            
            // Show My Class ID (Source) - unless in embed mode with connected badge
            if (!window.AUTO_JOIN_ROOM) {
                authInputGroup.style.display = 'none';
                myIdGroup.style.display = 'flex';
            }
        } else {
            btnSource.classList.remove('active');
            btnReceiver.classList.add('active');
            tabSource.classList.remove('active');
            tabReceiver.classList.add('active');
            
            // Show Input ID (Receiver) - unless in embed mode with connected badge
            if (!window.AUTO_JOIN_ROOM) {
                authInputGroup.style.display = 'flex';
                myIdGroup.style.display = 'none';
            }
        }
    }
    // Make switchTab globally available
    window.switchTab = switchTab;

    btnSource.addEventListener('click', () => switchTab('source'));
    btnReceiver.addEventListener('click', () => switchTab('receiver'));

    // Init state (Source by default, Receiver if embed mode)
    if (window.AUTO_JOIN_ROOM) {
        switchTab('receiver');
    } else {
        switchTab('source');
    }

    /* 3. UI REFERENCES */
    const ui = {
      srcLang: document.getElementById("srcLang"),
      tgtLang: document.getElementById("tgtLang"),
      micSelect: document.getElementById("micSelect"),
      speakerSelect: document.getElementById("speakerSelect"),
      broadcastBtn: document.getElementById("broadcastBtn"),
      floorDot: document.getElementById("floorDot"),
      floorText: document.getElementById("floorText"),
      recvDot: document.getElementById("recvDot"),
      recvText: document.getElementById("recvText"),
      historyBox: document.getElementById("historyBox"),
      liveCaptionBar: document.getElementById("liveCaptionBar"),
      sourceViz: document.getElementById("sourceViz"),
      recvViz: document.getElementById("recvViz"),
      myClassId: document.getElementById("myClassId"),
      joinInput: document.getElementById("joinInput"),
      joinBtn: document.getElementById("joinBtn"),
      copyIdBtn: document.getElementById("myIdGroup"),
      toast: document.getElementById("toast"),
      modal: document.getElementById("welcomeModal"),
      getStartedBtn: document.getElementById("getStartedBtn")
    };

    /* 4. HELPER FUNCTIONS */
    window.uiAddToHistory = function(src, tgt) {
        if (ui.historyBox.children[0] && ui.historyBox.children[0].innerText.includes("No history")) {
            ui.historyBox.innerHTML = '';
        }
        const item = document.createElement('div');
        item.className = 'history-item';
        item.innerHTML = `<div class="history-src">${src}</div><div class="history-tgt">${tgt}</div>`;
        ui.historyBox.prepend(item);
    };

    window.uiUpdateLiveBar = function(text) {
        ui.liveCaptionBar.textContent = text;
    };

    window.uiClearHistory = function() {
        ui.historyBox.innerHTML = '<div style="text-align:center; padding-top:20px; font-style:italic; opacity:0.5;">Class joined. History cleared.</div>';
    };

    // COPY TO CLIPBOARD
    ui.copyIdBtn.addEventListener("click", () => {
        const id = ui.myClassId.textContent;
        if(id !== "...") {
            navigator.clipboard.writeText(id).then(() => {
                ui.toast.classList.add("show");
                setTimeout(() => ui.toast.classList.remove("show"), 2000);
            }).catch(err => console.error(err));
        }
    });

    // Join Button Logic
    ui.joinBtn.addEventListener("click", () => {
        const id = ui.joinInput.value.trim();
        if(id.length > 0 && window.joinSupabaseRoom) {
            window.joinSupabaseRoom(id);
            ui.myClassId.textContent = id.toUpperCase();
            ui.joinInput.value = "";
            switchTab('receiver');
        }
    });
</script>

<!-- SUPABASE MODULE -->
<script type="module">
const SUPABASE_URL = "https://xscdwdnjujpkczfhqrgu.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhzY2R3ZG5qdWpwa2N6Zmhxcmd1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEzMzEwNjgsImV4cCI6MjA3NjkwNzA2OH0.xuVAkWA5y1oDW_jC52I8JJXF-ovU-5LIBsY9yXzy6cA";

let supabase = null;
let currentChannel = null;

try {
    supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    
    // Check for existing session
    supabase.auth.getSession().then(({ data }) => {
        if (data.session) {
            document.getElementById('welcomeModal').classList.add('hidden');
            // If not in embed mode, init room with generated ID
            if (!window.AUTO_JOIN_ROOM) {
                initRoom(document.getElementById('myClassId').textContent); 
            }
        }
    });

    // Embed Mode Auto-Join
    if (window.AUTO_JOIN_ROOM) {
        supabase.auth.getSession().then(async ({ data }) => {
            if (!data.session) {
                await supabase.auth.signInAnonymously();
            }
            initRoom(window.AUTO_JOIN_ROOM);
        });
    }
} catch (e) { console.error("Supabase Init Failed", e); }

document.getElementById('getStartedBtn').addEventListener('click', async () => {
    const btn = document.getElementById('getStartedBtn');
    btn.textContent = "Creating Account...";
    try {
        const { data, error } = await supabase.auth.signInAnonymously();
        if (error) throw error;
        document.getElementById('welcomeModal').classList.add('hidden');
        initRoom(document.getElementById('myClassId').textContent);
    } catch (err) {
        console.error("Auth Error", err);
        btn.textContent = "Try Again";
    }
});

function initRoom(classId) { joinRoom(classId); }

function joinRoom(classId) {
    if(!classId || !supabase) return;
    classId = classId.toUpperCase();
    if (currentChannel) supabase.removeChannel(currentChannel);
    currentChannel = supabase.channel(`room:${classId}`);
    
    currentChannel.on('broadcast', { event: 'translation' }, (payload) => {
        const data = payload.payload;
        window.uiAddToHistory(data.source_text, data.translated_text);
        window.uiUpdateLiveBar(data.source_text);
        if (document.getElementById('recvToggle').checked) {
            window.enqueueTTS(data.translated_text, data.target_lang);
        }
    }).subscribe();
    
    console.log("[Supabase] Joined room:", classId);
}

window.joinSupabaseRoom = joinRoom;

window.broadcastTranslation = async function(original, translated, srcLang, tgtLang) {
    if (!currentChannel || !original) return;
    await currentChannel.send({
        type: 'broadcast',
        event: 'translation',
        payload: {
            source_text: original,
            translated_text: translated,
            source_lang: srcLang,
            target_lang: tgtLang
        }
    });
};
</script>

<!-- AUDIO & TRANSLATION LOGIC -->
<script>
let inputCtx, inputAnalyser;
let recvCtx, recvAnalyser, recvSource;

async function populateDevices() {
    try {
        await navigator.mediaDevices.getUserMedia({ audio: true });
        const devices = await navigator.mediaDevices.enumerateDevices();
        ui.micSelect.innerHTML = '';
        ui.speakerSelect.innerHTML = '<option value="default">Default Speaker</option>';
        devices.forEach(d => {
            const opt = document.createElement('option');
            opt.value = d.deviceId;
            opt.text = d.label || `${d.kind} ${d.deviceId.slice(0,4)}`;
            if (d.kind === 'audioinput') ui.micSelect.appendChild(opt);
            if (d.kind === 'audiooutput') ui.speakerSelect.appendChild(opt);
        });
    } catch(e) { console.error("Permission denied", e); }
}

ui.speakerSelect.addEventListener('change', async () => {
    const tts = document.getElementById('tts');
    if (typeof tts.setSinkId === 'function') await tts.setSinkId(ui.speakerSelect.value);
});

function drawViz(canvas, analyser, color) {
    if (!analyser) return;
    const ctx = canvas.getContext('2d');
    const w = canvas.width, h = canvas.height;
    const data = new Uint8Array(analyser.frequencyBinCount);
    function render() {
        if (!analyser) { ctx.clearRect(0,0,w,h); return; }
        requestAnimationFrame(render);
        analyser.getByteFrequencyData(data);
        ctx.clearRect(0, 0, w, h);
        const barWidth = (w / data.length) * 2.5;
        let x = 0;
        for (let i = 0; i < data.length; i++) {
            const barHeight = (data[i] / 255) * h;
            ctx.fillStyle = color;
            ctx.fillRect(x, h - barHeight, barWidth, barHeight);
            x += barWidth + 1;
        }
    }
    render();
}

function initRecvViz() {
    const AC = window.AudioContext || window.webkitAudioContext;
    recvCtx = new AC();
    recvAnalyser = recvCtx.createAnalyser();
    recvAnalyser.fftSize = 64;
    const tts = document.getElementById('tts');
    recvSource = recvCtx.createMediaElementSource(tts);
    recvSource.connect(recvAnalyser);
    recvAnalyser.connect(recvCtx.destination);
    drawViz(ui.recvViz, recvAnalyser, '#f59e0b');
}

async function initSourceViz(stream) {
    if (inputCtx) inputCtx.close();
    const AC = window.AudioContext || window.webkitAudioContext;
    inputCtx = new AC();
    inputAnalyser = inputCtx.createAnalyser();
    inputAnalyser.fftSize = 64;
    const src = inputCtx.createMediaStreamSource(stream);
    src.connect(inputAnalyser);
    drawViz(ui.sourceViz, inputAnalyser, '#10b981');
}

const CARTESIA_KEY = "sk_car_JmdGRhBt1ocwhqmrxy2gaa";
const CARTESIA_CFG = {
  endpoint: "https://api.cartesia.ai/tts/bytes",
  version: "2025-04-16",
  model_id: "sonic-3-latest",
  voice_id: "9c7e6604-52c6-424a-9f9f-2c4ad89f3bb9",
  output_primary: { container: "wav", encoding: "pcm_f32le", sample_rate: 44100 },
  output_fallback:{ container: "wav", encoding: "pcm_s16le", sample_rate: 44100 },
  generation_config: { speed: 1.0, volume: 1.0 }
};

let ttsQueue = [];
let ttsBusy = false;
const ttsAudio = document.getElementById("tts");

document.getElementById('speedRange').oninput = e => {
    document.getElementById('speedVal').textContent = e.target.value + 'x';
    CARTESIA_CFG.generation_config.speed = parseFloat(e.target.value);
};
document.getElementById('volRange').oninput = e => {
    const vol = parseFloat(e.target.value);
    document.getElementById('volVal').textContent = vol.toFixed(1) + 'x';
    ttsAudio.volume = vol;
};

window.enqueueTTS = function(text, lang) {
    const parts = text.match(/[^.!?]+[.!?]*/g) || [text];
    parts.forEach(p => ttsQueue.push({ text: p, lang }));
    processTTS();
}

async function processTTS() {
    if (ttsBusy || !ttsQueue.length) return;
    ttsBusy = true;
    
    ui.recvText.textContent = "Speaking...";
    ui.recvDot.className = "dot receiving";
    if (recvCtx && recvCtx.state === 'suspended') {
        try { await recvCtx.resume(); } catch(e) { console.warn("AudioContext resume failed", e); }
    }

    const { text, lang } = ttsQueue.shift();
    const isoLang = lang ? lang.split('-')[0] : 'en';
    
    console.log(`[TTS] Processing: "${text.substring(0, 30)}..." in ${isoLang}`);
    
    try {
        const res = await fetch(CARTESIA_CFG.endpoint, {
            method: "POST",
            headers: { 
                "Content-Type": "application/json", 
                "X-API-Key": CARTESIA_KEY, 
                "Cartesia-Version": "2024-06-10" 
            },
            body: JSON.stringify({
                model_id: "sonic-multilingual",
                transcript: text,
                language: isoLang,
                voice: { mode: "id", id: "a0e99841-438c-4a64-b67c-3fedd69cf9a1" },
                output_format: { container: "wav", encoding: "pcm_f32le", sample_rate: 44100 }
            })
        });
        
        if (!res.ok) {
            const errText = await res.text();
            throw new Error(`API ${res.status}: ${errText.substring(0, 100)}`);
        }
        
        const blob = await res.blob();
        console.log("[TTS] Blob received:", blob.size, "bytes");
        
        const url = URL.createObjectURL(blob);
        ttsAudio.src = url;
        
        try {
            await ttsAudio.play();
            console.log("[TTS] Playing audio");
        } catch(playErr) {
            console.error("[TTS] Playback blocked:", playErr);
            ui.toast.textContent = "Tap 'Test TTS' to enable audio";
            ui.toast.style.background = "#f59e0b";
            ui.toast.classList.add("show");
            setTimeout(() => ui.toast.classList.remove("show"), 3000);
        }
        
        await new Promise(r => { 
            ttsAudio.onended = () => { URL.revokeObjectURL(url); r(); };
            setTimeout(r, (text.length * 80) + 5000);
        });
        
    } catch(e) { 
        console.error("[TTS] Error:", e);
        ui.toast.textContent = "TTS Error: " + (e.message || "Unknown").substring(0, 30);
        ui.toast.style.background = "#ef4444";
        ui.toast.classList.add("show");
        setTimeout(() => ui.toast.classList.remove("show"), 3000);
    }
    
    ui.recvText.textContent = "Receiver Idle";
    ui.recvDot.className = "dot active";
    ttsBusy = false;
    processTTS();
}

const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
let recognizer = null;
let listening = false;

async function startBroadcasting() {
    if (!SpeechRecognition) return alert("WebSpeech API not supported");
    if (listening) return stopBroadcasting();

    try {
        const deviceId = ui.micSelect.value;
        const constraints = { audio: deviceId === 'default' ? true : { deviceId: { exact: deviceId } } };
        const stream = await navigator.mediaDevices.getUserMedia(constraints);
        initSourceViz(stream);
    } catch(e) { return alert("Mic Error"); }

    recognizer = new SpeechRecognition();
    recognizer.continuous = true;
    recognizer.interimResults = true;
    recognizer.lang = ui.srcLang.value;

    recognizer.onstart = () => {
        listening = true;
        ui.floorText.textContent = "On Air";
        ui.floorDot.className = "dot active";
        ui.broadcastBtn.textContent = "Stop Broadcasting";
        ui.broadcastBtn.className = "btn btn-red";
        ui.liveCaptionBar.textContent = "Listening...";
    };
    recognizer.onend = () => { if (listening) recognizer.start(); else stopBroadcasting(); };
    recognizer.onresult = async (e) => {
        let interim = "";
        for (let i = e.resultIndex; i < e.results.length; i++) {
            const res = e.results[i];
            if (res.isFinal) {
                const txt = res[0].transcript.trim();
                if (txt) {
                    const tl = getGoogleTranslateCode(ui.tgtLang.value);
                    const targetLang = ui.tgtLang.value;
                    const url = `https://translate.googleapis.com/translate_a/single?client=gtx&sl=auto&tl=${tl}&dt=t&q=${encodeURIComponent(txt)}`;
                    const r = await fetch(url);
                    const d = await r.json();
                    const trans = d[0].map(x=>x[0]).join("");
                    if(window.broadcastTranslation) window.broadcastTranslation(txt, trans, "auto", targetLang);
                }
            } else interim += res[0].transcript;
        }
        ui.liveCaptionBar.textContent = interim || (listening ? "Listening..." : "");
    };
    recognizer.start();
}

function stopBroadcasting() {
    listening = false;
    if (recognizer) recognizer.stop();
    ui.floorText.textContent = "Mic Off";
    ui.floorDot.className = "dot";
    ui.broadcastBtn.textContent = "Start Broadcasting";
    ui.broadcastBtn.className = "btn btn-green";
    ui.liveCaptionBar.textContent = "";
    if (inputCtx) inputCtx.close();
}

ui.broadcastBtn.addEventListener('click', startBroadcasting);

const LANGUAGES = [
  { code: 'en-US', gtCode: 'en', name: 'English (US)', flag: 'ðŸ‡ºðŸ‡¸' },
  { code: 'en-GB', gtCode: 'en', name: 'English (UK)', flag: 'ðŸ‡¬ðŸ‡§' },
  { code: 'es-ES', gtCode: 'es', name: 'Spanish', flag: 'ðŸ‡ªðŸ‡¸' },
  { code: 'fr-FR', gtCode: 'fr', name: 'French', flag: 'ðŸ‡«ðŸ‡·' },
  { code: 'de-DE', gtCode: 'de', name: 'German', flag: 'ðŸ‡©ðŸ‡ª' },
  { code: 'nl-NL', gtCode: 'nl', name: 'Dutch', flag: 'ðŸ‡³ðŸ‡±' },
  { code: 'it-IT', gtCode: 'it', name: 'Italian', flag: 'ðŸ‡®ðŸ‡¹' },
  { code: 'pt-BR', gtCode: 'pt', name: 'Portuguese', flag: 'ðŸ‡§ðŸ‡·' },
  { code: 'ru-RU', gtCode: 'ru', name: 'Russian', flag: 'ðŸ‡·ðŸ‡º' },
  { code: 'ja-JP', gtCode: 'ja', name: 'Japanese', flag: 'ðŸ‡¯ðŸ‡µ' },
  { code: 'zh-CN', gtCode: 'zh-CN', name: 'Chinese (Simplified)', flag: 'ðŸ‡¨ðŸ‡³' },
  { code: 'zh-TW', gtCode: 'zh-TW', name: 'Chinese (Traditional)', flag: 'ðŸ‡¹ðŸ‡¼' },
  { code: 'ko-KR', gtCode: 'ko', name: 'Korean', flag: 'ðŸ‡°ðŸ‡·' },
  { code: 'ar-SA', gtCode: 'ar', name: 'Arabic', flag: 'ðŸ‡¸ðŸ‡¦' },
  { code: 'hi-IN', gtCode: 'hi', name: 'Hindi', flag: 'ðŸ‡®ðŸ‡³' },
  { code: 'tr-TR', gtCode: 'tr', name: 'Turkish', flag: 'ðŸ‡¹ðŸ‡·' },
  { code: 'pl-PL', gtCode: 'pl', name: 'Polish', flag: 'ðŸ‡µðŸ‡±' },
  { code: 'uk-UA', gtCode: 'uk', name: 'Ukrainian', flag: 'ðŸ‡ºðŸ‡¦' },
  { code: 'fil-PH', gtCode: 'tl', name: 'Filipino/Tagalog', flag: 'ðŸ‡µðŸ‡­' },
  { code: 'vi-VN', gtCode: 'vi', name: 'Vietnamese', flag: 'ðŸ‡»ðŸ‡³' },
  { code: 'th-TH', gtCode: 'th', name: 'Thai', flag: 'ðŸ‡¹ðŸ‡­' },
  { code: 'id-ID', gtCode: 'id', name: 'Indonesian', flag: 'ðŸ‡®ðŸ‡©' },
  { code: 'ms-MY', gtCode: 'ms', name: 'Malay', flag: 'ðŸ‡²ðŸ‡¾' },
  { code: 'sv-SE', gtCode: 'sv', name: 'Swedish', flag: 'ðŸ‡¸ðŸ‡ª' },
  { code: 'nb-NO', gtCode: 'no', name: 'Norwegian', flag: 'ðŸ‡³ðŸ‡´' },
  { code: 'da-DK', gtCode: 'da', name: 'Danish', flag: 'ðŸ‡©ðŸ‡°' },
  { code: 'fi-FI', gtCode: 'fi', name: 'Finnish', flag: 'ðŸ‡«ðŸ‡®' },
  { code: 'el-GR', gtCode: 'el', name: 'Greek', flag: 'ðŸ‡¬ðŸ‡·' },
  { code: 'he-IL', gtCode: 'iw', name: 'Hebrew', flag: 'ðŸ‡®ðŸ‡±' },
  { code: 'cs-CZ', gtCode: 'cs', name: 'Czech', flag: 'ðŸ‡¨ðŸ‡¿' },
  { code: 'hu-HU', gtCode: 'hu', name: 'Hungarian', flag: 'ðŸ‡­ðŸ‡º' },
  { code: 'ro-RO', gtCode: 'ro', name: 'Romanian', flag: 'ðŸ‡·ðŸ‡´' },
  { code: 'sk-SK', gtCode: 'sk', name: 'Slovak', flag: 'ðŸ‡¸ðŸ‡°' },
  { code: 'bg-BG', gtCode: 'bg', name: 'Bulgarian', flag: 'ðŸ‡§ðŸ‡¬' },
  { code: 'ca-ES', gtCode: 'ca', name: 'Catalan', flag: 'ðŸ´' },
  { code: 'sr-RS', gtCode: 'sr', name: 'Serbian', flag: 'ðŸ‡·ðŸ‡¸' },
  { code: 'hr-HR', gtCode: 'hr', name: 'Croatian', flag: 'ðŸ‡­ðŸ‡·' },
  { code: 'sl-SI', gtCode: 'sl', name: 'Slovenian', flag: 'ðŸ‡¸ðŸ‡®' },
  { code: 'et-EE', gtCode: 'et', name: 'Estonian', flag: 'ðŸ‡ªðŸ‡ª' },
  { code: 'lv-LV', gtCode: 'lv', name: 'Latvian', flag: 'ðŸ‡±ðŸ‡»' },
  { code: 'lt-LT', gtCode: 'lt', name: 'Lithuanian', flag: 'ðŸ‡±ðŸ‡¹' },
  { code: 'fa-IR', gtCode: 'fa', name: 'Persian', flag: 'ðŸ‡®ðŸ‡·' },
  { code: 'ur-PK', gtCode: 'ur', name: 'Urdu', flag: 'ðŸ‡µðŸ‡°' },
  { code: 'bn-IN', gtCode: 'bn', name: 'Bengali', flag: 'ðŸ‡§ðŸ‡©' },
  { code: 'ta-IN', gtCode: 'ta', name: 'Tamil', flag: 'ðŸ‡®ðŸ‡³' },
  { code: 'te-IN', gtCode: 'te', name: 'Telugu', flag: 'ðŸ‡®ðŸ‡³' },
  { code: 'mr-IN', gtCode: 'mr', name: 'Marathi', flag: 'ðŸ‡®ðŸ‡³' },
  { code: 'sw-KE', gtCode: 'sw', name: 'Swahili', flag: 'ðŸ‡°ðŸ‡ª' },
  { code: 'af-ZA', gtCode: 'af', name: 'Afrikaans', flag: 'ðŸ‡¿ðŸ‡¦' }
];

const languageDisplayNames = typeof Intl !== 'undefined' && Intl.DisplayNames
    ? new Intl.DisplayNames(['en'], { type: 'language' })
    : null;

function getLanguageLabel(lang) {
    const displayName = languageDisplayNames ? languageDisplayNames.of(lang.code) : lang.name;
    const baseName = displayName || lang.name || lang.code;
    return `${lang.flag ? lang.flag + ' ' : ''}${baseName}`;
}

// Helper to get Google Translate code from language selection
function getGoogleTranslateCode(langCode) {
    const lang = LANGUAGES.find(l => l.code === langCode);
    return lang ? lang.gtCode : langCode.split('-')[0];
}

/* SAVE PREFERENCES EVENT LISTENERS */
ui.srcLang.addEventListener('change', (e) => {
    localStorage.setItem('orbit_src_lang', e.target.value);
    if (recognizer && listening) {
        recognizer.lang = e.target.value;
    }
});

ui.tgtLang.addEventListener('change', (e) => {
    localStorage.setItem('orbit_tgt_lang', e.target.value);
});

function init() {
    const opts = LANGUAGES.map(l => `<option value="${l.code}">${getLanguageLabel(l)}</option>`).join('');
    ui.srcLang.innerHTML = opts;
    ui.tgtLang.innerHTML = opts;

    const savedSrc = localStorage.getItem('orbit_src_lang');
    const savedTgt = localStorage.getItem('orbit_tgt_lang');
    const browserLang = navigator.language;

    if (savedSrc) {
        ui.srcLang.value = savedSrc;
    } else {
        ui.srcLang.value = "en-US";
    }

    if (savedTgt) {
        ui.tgtLang.value = savedTgt;
    } else {
        const exists = LANGUAGES.find(l => l.code === browserLang || l.code.startsWith(browserLang));
        if (exists) {
            ui.tgtLang.value = exists.code;
        } else {
            ui.tgtLang.value = "nl-BE";
        }
    }
    
    populateDevices();
    initRecvViz();

// Test TTS Button
document.getElementById('testTTSBtn').addEventListener('click', () => {
    console.log("[TTS] Test button clicked");
    window.enqueueTTS("This is a test of the audio system. If you hear this, TTS is working.", "en-US");
});
}

init();
</script>
</body>
