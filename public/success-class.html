<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Success Class Translator</title>
  
  <!-- Supabase SDK -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root {
      --bg-app: #000000;
      --bg-panel: #121212;
      --bg-card: #1e1e1e;
      --bg-input: #111;
      --text-main: #e0e0e0;
      --text-muted: #888888;
      --accent-orange: #f59e0b;
      --accent-green: #10b981;
      --accent-red: #ef4444;
      --border: #333;
      --radius: 16px;
      --font: "SF Pro Text", "SF Pro Display", -apple-system, BlinkMacSystemFont, "Helvetica Neue", "Segoe UI", system-ui, sans-serif;
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

    body {
      margin: 0;
      background: var(--bg-app);
      color: var(--text-main);
      font-family: var(--font);
      height: 100vh;
      overflow: hidden;
      display: flex;
      justify-content: center;
    }

    /* === WELCOME MODAL === */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.6);
      -webkit-backdrop-filter: blur(16px);
      backdrop-filter: blur(16px);
      z-index: 9999;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 1;
      transition: opacity 0.5s ease, visibility 0.5s;
    }
    
    .modal-overlay.hidden {
      opacity: 0;
      visibility: hidden;
      pointer-events: none;
    }

    .modal-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      padding: 40px 30px;
      border-radius: 24px;
      text-align: center;
      max-width: 90%;
      width: 360px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.8);
      transform: scale(1);
      transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }
    
    .modal-overlay.hidden .modal-card {
      transform: scale(0.9);
    }

    .modal-icon {
      width: 64px; height: 64px;
      background: linear-gradient(135deg, var(--accent-orange), #d97706);
      border-radius: 16px;
      margin: 0 auto 20px auto;
      display: flex; align-items: center; justify-content: center;
      box-shadow: 0 10px 30px rgba(245, 158, 11, 0.3);
    }
    
    .modal-title { font-size: 22px; font-weight: 700; color: #fff; margin-bottom: 8px; }
    .modal-desc { font-size: 14px; color: var(--text-muted); line-height: 1.5; margin-bottom: 30px; }

    .btn-large {
      width: 100%;
      padding: 16px;
      background: var(--accent-green);
      color: white;
      border: none;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 700;
      cursor: pointer;
      transition: transform 0.1s;
      box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
    }
    .btn-large:active { transform: scale(0.98); }

    /* === MAIN APP === */
    .app-container {
      width: 100%;
      max-width: 500px;
      background: var(--bg-panel);
      display: flex;
      flex-direction: column;
      height: 100%;
      position: relative;
      box-shadow: 0 0 40px rgba(0,0,0,0.5);
    }

    @media (min-width: 501px) {
      body { align-items: center; padding: 20px; }
      .app-container { height: 90vh; border-radius: var(--radius); border: 1px solid var(--border); }
    }

    .header {
      padding: 16px 20px;
      border-bottom: 1px solid var(--border);
      background: var(--bg-panel);
      z-index: 20;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    
    .header-top { display: flex; justify-content: space-between; align-items: center; }
    .header h1 { margin: 0; font-size: 17px; font-weight: 700; letter-spacing: -0.5px; }
    .header p { margin: 2px 0 0 0; font-size: 11px; color: var(--text-muted); }

    .auth-bar {
      display: flex; gap: 8px; background: #252525; padding: 6px;
      border-radius: 10px; border: 1px solid #333;
      min-height: 46px; /* Maintain height to prevent layout jumps */
    }

    .auth-input-group { flex: 1; display: none; position: relative; } /* Hidden by default */

    .auth-input {
      width: 100%; background: #111; border: 1px solid #444; color: #fff;
      padding: 8px 10px; border-radius: 6px 0 0 6px; font-size: 13px;
      outline: none; font-family: monospace; text-transform: uppercase;
    }
    .auth-input:focus { border-color: var(--accent-orange); }

    .btn-join {
      background: var(--accent-green); color: white; border: none;
      border-radius: 0 6px 6px 0; padding: 0 12px; font-size: 12px;
      font-weight: 700; cursor: pointer; text-transform: uppercase;
    }

    .my-id-container {
      display: flex; align-items: center; gap: 6px; padding: 0 12px;
      background: rgba(245, 158, 11, 0.1); border: 1px solid rgba(245, 158, 11, 0.3);
      border-radius: 6px; cursor: pointer; width: 100%; justify-content: space-between;
      transition: background 0.2s;
    }
    .my-id-container:active { background: rgba(245, 158, 11, 0.3); transform: scale(0.98); }
    
    .my-id-label { font-size: 9px; color: var(--accent-orange); font-weight: 600; text-transform: uppercase; }
    .my-id-val { font-size: 14px; color: #fff; font-family: monospace; font-weight: 700; letter-spacing: 1px; }

    .tabs { display: flex; background: var(--bg-panel); border-bottom: 1px solid var(--border); flex-shrink: 0; z-index: 15; }
    .tab-btn {
      flex: 1; background: transparent; border: none; color: var(--text-muted);
      padding: 16px; font-size: 13px; font-weight: 600; cursor: pointer;
      text-transform: uppercase; letter-spacing: 1px; border-bottom: 3px solid transparent;
      transition: all 0.2s;
    }
    .tab-btn.active {
      color: var(--accent-orange); border-bottom-color: var(--accent-orange);
      background: rgba(245, 158, 11, 0.05);
    }

    .tab-content {
      flex: 1; overflow-y: auto; overflow-x: hidden; padding: 16px;
      display: none; flex-direction: column; gap: 16px; padding-bottom: 80px; 
    }
    .tab-content.active { display: flex; }

    .card { background: var(--bg-card); border-radius: 12px; padding: 16px; border: 1px solid #2a2a2a; }
    .card-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
    .card-label {
      font-size: 11px; color: var(--text-muted); text-transform: uppercase;
      letter-spacing: 0.8px; font-weight: 600; margin-bottom: 8px; display: block;
    }

    .status-badge { display: flex; align-items: center; gap: 10px; font-size: 14px; font-weight: 500; }
    .dot { width: 8px; height: 8px; border-radius: 50%; background: #444; transition: 0.3s; }
    .dot.active { background: var(--accent-green); box-shadow: 0 0 10px var(--accent-green); }
    .dot.receiving { background: var(--accent-orange); box-shadow: 0 0 10px var(--accent-orange); }

    select {
      width: 100%; background: #111; color: white; border: 1px solid #333; padding: 14px;
      border-radius: 8px; font-size: 15px; outline: none; appearance: none;
      background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23888888%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E");
      background-repeat: no-repeat; background-position: right 14px top 50%; background-size: 10px auto;
    }

    .btn {
      width: 100%; padding: 16px; border-radius: 8px; border: none;
      font-weight: 600; font-size: 15px; cursor: pointer; transition: transform 0.1s;
    }
    .btn:active { transform: scale(0.98); }
    .btn-green { background: var(--accent-green); color: white; }
    .btn-red { background: var(--accent-red); color: white; }
    .btn-outline {
      background: transparent; border: 1px solid #444; color: #888;
      padding: 6px 12px; font-size: 12px; width: auto; border-radius: 6px; cursor: default;
    }

    .switch { position: relative; display: inline-block; width: 46px; height: 26px; }
    .switch input { opacity: 0; width: 0; height: 0; }
    .slider {
      position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
      background-color: #333; border-radius: 34px; transition: .3s;
    }
    .slider:before {
      position: absolute; content: ""; height: 20px; width: 20px; left: 3px; bottom: 3px;
      background-color: #888; border-radius: 50%; transition: .3s;
    }
    input:checked + .slider { background-color: var(--accent-orange); }
    input:checked + .slider:before { transform: translateX(20px); background-color: white; }

    .range-wrap { margin-bottom: 16px; }
    .range-label-row { display: flex; justify-content: space-between; font-size: 12px; margin-bottom: 8px; color: var(--text-muted); }
    input[type=range] { -webkit-appearance: none; appearance: none; width: 100%; background: transparent; }
    input[type=range]::-webkit-slider-thumb {
      -webkit-appearance: none; height: 18px; width: 18px; border-radius: 50%;
      background: var(--accent-orange); cursor: pointer; margin-top: -7px;
      box-shadow: 0 0 10px rgba(245, 158, 11, 0.3);
    }
    input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; cursor: pointer; background: #333; border-radius: 2px;
    }

    .history-box {
      flex: 1; min-height: 100px;
      font-family: monospace; font-size: 13px; color: #aaa;
      display: flex; flex-direction: column; gap: 8px;
    }
    .history-item { padding-bottom: 8px; border-bottom: 1px solid #222; animation: slideIn 0.3s ease; }
    .history-src { color: var(--accent-orange); font-weight: 600; margin-bottom: 2px; }
    .history-tgt { color: var(--text-main); }

    @keyframes slideIn { from { opacity: 0; transform: translateX(-10px); } to { opacity: 1; transform: translateX(0); } }

    .live-caption-bar {
      position: absolute; bottom: 0; left: 0; right: 0;
      background: rgba(18, 18, 18, 0.95);
      border-top: 1px solid var(--border);
      padding: 16px;
      min-height: 60px;
      display: flex; align-items: center; justify-content: center;
      text-align: center; font-size: 15px; color: var(--accent-orange);
      font-weight: 500; line-height: 1.4;
      -webkit-backdrop-filter: blur(8px);
      backdrop-filter: blur(8px);
      z-index: 100;
    }

    .viz-canvas { width: 100%; height: 48px; background: #111; border-radius: 8px; margin-top: 12px; display: block; }

    /* TOAST NOTIFICATION */
    .toast {
      position: absolute; top: 120px; left: 50%; transform: translateX(-50%) translateY(20px);
      background: var(--accent-green); color: white; padding: 10px 24px;
      border-radius: 30px; font-size: 13px; font-weight: 600; opacity: 0;
      pointer-events: none; transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); 
      z-index: 2000; box-shadow: 0 8px 20px rgba(0,0,0,0.4);
      display: flex; align-items: center; gap: 8px;
    }
    .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

    /* ROLE BADGES */
    .role-badge {
      display: inline-block; padding: 4px 8px; border-radius: 4px;
      font-size: 10px; font-weight: 700; text-transform: uppercase;
      margin-left: 8px; vertical-align: middle; letter-spacing: 0.5px;
    }
    .role-host { background: rgba(245, 158, 11, 0.2); color: var(--accent-orange); border: 1px solid rgba(245, 158, 11, 0.4); }
    .role-part { background: rgba(16, 185, 129, 0.2); color: var(--accent-green); border: 1px solid rgba(16, 185, 129, 0.4); } /* Green/Blueish */

    /* Scrollbar */
    ::-webkit-scrollbar { width: 4px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: #333; border-radius: 2px; }
  </style>
</head>

<body>

<!-- Auth Modal (Existing...) -->
<!-- ... (Lines 287-338 unchanged) ... -->

<div class="app-container" id="appContainer">
  
  <div class="header">
    <div class="header-top">
      <div>
        <div style="display:flex; align-items:center;">
            <h1>Success Class Translator</h1>
            <span id="roleBadge" class="role-badge role-host">HOST</span>
        </div>
        <p>Supabase Powered â€¢ Real-time</p>
      </div>
    </div>

    <!-- Auth / Room Bar -->
<!-- ... (Lines 349-484) ... -->

    /* 2. TAB SWITCHING LOGIC (Shows/Hides ID inputs) */
    const btnSource = document.getElementById('btn-source');
    const btnReceiver = document.getElementById('btn-receiver');
    const tabSource = document.getElementById('tab-source');
    const tabReceiver = document.getElementById('tab-receiver');
    const authInputGroup = document.getElementById('authInputGroup');
    const myIdGroup = document.getElementById('myIdGroup');
    const roleBadge = document.getElementById('roleBadge');
    const appContainer = document.getElementById('appContainer');

    function switchTab(target) {
        if(target === 'source') {
            btnSource.classList.add('active');
            btnReceiver.classList.remove('active');
            tabSource.classList.add('active');
            tabReceiver.classList.remove('active');
            
            // Show My Class ID (Source)
            authInputGroup.style.display = 'none';
            myIdGroup.style.display = 'flex';

            // Role State: HOST
            roleBadge.textContent = "HOST";
            roleBadge.className = "role-badge role-host";
            appContainer.style.boxShadow = "0 0 40px rgba(245, 158, 11, 0.1)"; // Orange Glow
            
        } else {
            btnSource.classList.remove('active');
            btnReceiver.classList.add('active');
            tabSource.classList.remove('active');
            tabReceiver.classList.add('active');
            
            // Show Input ID (Receiver)
            authInputGroup.style.display = 'flex';
            myIdGroup.style.display = 'none';

            // Role State: PARTICIPANT
            roleBadge.textContent = "PARTICIPANT";
            roleBadge.className = "role-badge role-part";
            appContainer.style.boxShadow = "0 0 40px rgba(16, 185, 129, 0.1)"; // Green Glow
        }
    }

    btnSource.addEventListener('click', () => switchTab('source'));
    btnReceiver.addEventListener('click', () => switchTab('receiver'));


    // Init state (Source)
    switchTab('source');

    /* 3. UI REFERENCES */
    const ui = {
      srcLang: document.getElementById("srcLang"),
      tgtLang: document.getElementById("tgtLang"),
      micSelect: document.getElementById("micSelect"),
      speakerSelect: document.getElementById("speakerSelect"),
      broadcastBtn: document.getElementById("broadcastBtn"),
      floorDot: document.getElementById("floorDot"),
      floorText: document.getElementById("floorText"),
      recvDot: document.getElementById("recvDot"),
      recvText: document.getElementById("recvText"),
      historyBox: document.getElementById("historyBox"),
      liveCaptionBar: document.getElementById("liveCaptionBar"),
      sourceViz: document.getElementById("sourceViz"),
      recvViz: document.getElementById("recvViz"),
      myClassId: document.getElementById("myClassId"),
      joinInput: document.getElementById("joinInput"),
      joinBtn: document.getElementById("joinBtn"),
      copyIdBtn: document.getElementById("myIdGroup"),
      toast: document.getElementById("toast"),
      modal: document.getElementById("authModal"),
      // auth references
      authEmail: document.getElementById("emailInput"),
      authPass: document.getElementById("passwordInput"),
      authBtn: document.getElementById("authBtn"),
      authError: document.getElementById("authError"),
      tabLogin: document.getElementById("tabLogin"),
      tabSignup: document.getElementById("tabSignup")
    };

    /* 4. HELPER FUNCTIONS */
    window.uiAddToHistory = function(src, tgt) {
        if (ui.historyBox.children[0] && ui.historyBox.children[0].innerText.includes("No history")) {
            ui.historyBox.innerHTML = '';
        }
        const item = document.createElement('div');
        item.className = 'history-item';
        item.innerHTML = `<div class="history-src">${src}</div><div class="history-tgt">${tgt}</div>`;
        ui.historyBox.prepend(item);
    };

    window.uiUpdateLiveBar = function(text) {
        ui.liveCaptionBar.textContent = text;
    };

    window.uiClearHistory = function() {
        ui.historyBox.innerHTML = '<div style="text-align:center; padding-top:20px; font-style:italic; opacity:0.5;">Class joined. History cleared.</div>';
    };

    // COPY TO CLIPBOARD
    ui.copyIdBtn.addEventListener("click", () => {
        const id = ui.myClassId.textContent;
        if(id !== "...") {
            navigator.clipboard.writeText(id).then(() => {
                ui.toast.classList.add("show");
                setTimeout(() => ui.toast.classList.remove("show"), 2000);
            }).catch(err => console.error(err));
        }
    });

    // Join Button Logic
    ui.joinBtn.addEventListener("click", () => {
        const id = ui.joinInput.value.trim();
        if(id.length > 0 && window.joinSupabaseRoom) {
            window.joinSupabaseRoom(id);
            ui.myClassId.textContent = id.toUpperCase();
            ui.joinInput.value = "";
            switchTab('receiver');
        }
    });

    // --- AUTH UI LOGIC ---
    let authMode = 'login';
    function setAuthMode(m) {
        authMode = m;
        ui.tabLogin.classList.toggle('active', m === 'login');
        ui.tabSignup.classList.toggle('active', m === 'signup');
        ui.tabSignup.style.color = m === 'signup' ? '#f59e0b' : '#666';
        ui.authBtn.textContent = m === 'login' ? 'Authenticate' : 'Create & Access';
    }
    ui.tabLogin.onclick = () => setAuthMode('login');
    ui.tabSignup.onclick = () => setAuthMode('signup');

</script>

<!-- SUPABASE MODULE -->
<script type="module">
const SUPABASE_URL = "https://xscdwdnjujpkczfhqrgu.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhzY2R3ZG5qdWpwa2N6Zmhxcmd1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEzMzEwNjgsImV4cCI6MjA3NjkwNzA2OH0.xuVAkWA5y1oDW_jC52I8JJXF-ovU-5LIBsY9yXzy6cA";

let supabase = null;
let currentChannel = null;

try {
    supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    
    // Check Session on Load
    supabase.auth.getSession().then(({ data }) => {
        if (data.session) {
            document.getElementById('authModal').classList.add('hidden');
            initRoom(document.getElementById('myClassId').textContent); 
        }
    });
} catch (e) { console.error("Supabase Init Failed", e); }

document.getElementById('authBtn').addEventListener('click', async () => {
    const btn = document.getElementById('authBtn');
    const errBox = document.getElementById('authError');
    const email = document.getElementById('emailInput').value;
    const password = document.getElementById('passwordInput').value;

    btn.textContent = "Processing...";
    btn.disabled = true;
    errBox.textContent = "";

    try {
        let authRes;
        if (typeof authMode !== 'undefined' && authMode === 'signup') {
            authRes = await supabase.auth.signUp({ email, password });
        } else {
            authRes = await supabase.auth.signInWithPassword({ email, password });
        }

        if (authRes.error) throw authRes.error;

        document.getElementById('authModal').classList.add('hidden');
        initRoom(document.getElementById('myClassId').textContent);

    } catch (err) {
        console.error("Auth Error", err);
        errBox.textContent = err.message || "Authentication failed.";
        btn.textContent = "Try Again";
        btn.disabled = false;
    }
});

function initRoom(classId) { joinRoom(classId); }

function joinRoom(classId) {
    if(!classId || !supabase) return;
    classId = classId.toUpperCase();
    if (currentChannel) supabase.removeChannel(currentChannel);
    currentChannel = supabase.channel(`room:${classId}`);
    
    currentChannel.on('broadcast', { event: 'translation' }, (payload) => {
        const data = payload.payload;
        window.uiAddToHistory(data.source_text, data.translated_text);
        window.uiUpdateLiveBar(data.source_text);
        if (document.getElementById('recvToggle').checked) {
            window.enqueueTTS(data.translated_text, data.target_lang);
        }
    }).subscribe();
}

window.joinSupabaseRoom = joinRoom;

window.broadcastTranslation = async function(original, translated, srcLang, tgtLang) {
    if (!currentChannel || !original) return;
    await currentChannel.send({
        type: 'broadcast',
        event: 'translation',
        payload: {
            source_text: original,
            translated_text: translated,
            source_lang: srcLang,
            target_lang: tgtLang
        }
    });
};
</script>

<!-- AUDIO & TRANSLATION LOGIC -->
<script>
let inputCtx, inputAnalyser;
let recvCtx, recvAnalyser, recvSource;

async function populateDevices() {
    try {
        await navigator.mediaDevices.getUserMedia({ audio: true });
        const devices = await navigator.mediaDevices.enumerateDevices();
        
        ui.micSelect.innerHTML = '<option value="default" selected>Default Microphone (Auto)</option>';
        ui.speakerSelect.innerHTML = '<option value="default">Default Speaker</option>';
        
        devices.forEach(d => {
            const opt = document.createElement('option');
            opt.value = d.deviceId;
            opt.text = d.label || `${d.kind} ${d.deviceId.slice(0,4)}`;
            if (d.kind === 'audioinput' && d.deviceId !== 'default') ui.micSelect.appendChild(opt);
            if (d.kind === 'audiooutput' && d.deviceId !== 'default') ui.speakerSelect.appendChild(opt);
        });
        
        // Ensure default is selected
        ui.micSelect.value = "default";
        
    } catch(e) { 
        console.error("Device Enumeration Error", e);
        // Don't alert here to avoid spamming on load, just log.
        ui.micSelect.innerHTML = '<option value="default">Default Mic (Access Denied)</option>';
    }
}

ui.speakerSelect.addEventListener('change', async () => {
    const tts = document.getElementById('tts');
    if (typeof tts.setSinkId === 'function') await tts.setSinkId(ui.speakerSelect.value);
});

function drawViz(canvas, analyser, color) {
    if (!analyser) return;
    const ctx = canvas.getContext('2d');
    const w = canvas.width, h = canvas.height;
    const data = new Uint8Array(analyser.frequencyBinCount);
    function render() {
        if (!analyser) { ctx.clearRect(0,0,w,h); return; }
        requestAnimationFrame(render);
        analyser.getByteFrequencyData(data);
        ctx.clearRect(0, 0, w, h);
        const barWidth = (w / data.length) * 2.5;
        let x = 0;
        for (let i = 0; i < data.length; i++) {
            const barHeight = (data[i] / 255) * h;
            ctx.fillStyle = color;
            ctx.fillRect(x, h - barHeight, barWidth, barHeight);
            x += barWidth + 1;
        }
    }
    render();
}

function initRecvViz() {
    const AC = window.AudioContext || window.webkitAudioContext;
    recvCtx = new AC();
    recvAnalyser = recvCtx.createAnalyser();
    recvAnalyser.fftSize = 64;
    const tts = document.getElementById('tts');
    recvSource = recvCtx.createMediaElementSource(tts);
    recvSource.connect(recvAnalyser);
    recvAnalyser.connect(recvCtx.destination);
    drawViz(ui.recvViz, recvAnalyser, '#f59e0b');
}

async function initSourceViz(stream) {
    if (inputCtx) inputCtx.close();
    const AC = window.AudioContext || window.webkitAudioContext;
    inputCtx = new AC();
    inputAnalyser = inputCtx.createAnalyser();
    inputAnalyser.fftSize = 64;
    const src = inputCtx.createMediaStreamSource(stream);
    src.connect(inputAnalyser);
    drawViz(ui.sourceViz, inputAnalyser, '#10b981');
}

const CARTESIA_KEY = "sk_car_JmdGRhBt1ocwhqmrxy2gaa";
const CARTESIA_CFG = {
  endpoint: "https://api.cartesia.ai/tts/bytes",
  version: "2025-04-16",
  model_id: "sonic-3-latest",
  voice_id: "9c7e6604-52c6-424a-9f9f-2c4ad89f3bb9",
  output_primary: { container: "wav", encoding: "pcm_f32le", sample_rate: 44100 },
  output_fallback:{ container: "wav", encoding: "pcm_s16le", sample_rate: 44100 },
  generation_config: { speed: 1.0, volume: 1.0 }
};

let ttsQueue = [];
let ttsBusy = false;
const ttsAudio = document.getElementById("tts");

document.getElementById('speedRange').oninput = e => {
    document.getElementById('speedVal').textContent = e.target.value + 'x';
    CARTESIA_CFG.generation_config.speed = parseFloat(e.target.value);
};
document.getElementById('volRange').oninput = e => {
    const vol = parseFloat(e.target.value);
    document.getElementById('volVal').textContent = vol.toFixed(1) + 'x';
    ttsAudio.volume = vol;
};

window.enqueueTTS = function(text, lang) {
    const parts = text.match(/[^.!?]+[.!?]*/g) || [text];
    parts.forEach(p => ttsQueue.push({ text: p, lang }));
    processTTS();
}

async function processTTS() {
    if (ttsBusy || !ttsQueue.length) return;
    ttsBusy = true;
    
    ui.recvText.textContent = "Speaking...";
    ui.recvDot.className = "dot receiving";
    
    // Resume AudioContext if needed (user interaction check)
    if (recvCtx && recvCtx.state === 'suspended') {
        try { await recvCtx.resume(); } catch(e) { console.warn("AudioContext resume failed", e); }
    }

    const { text, lang } = ttsQueue.shift();
    // Cartesia expects 'en', 'es', 'fr', etc.
    const isoLang = lang ? lang.split('-')[0] : 'en';

    console.log(`[TTS] Requesting: "${text.substring(0, 20)}..." in ${isoLang}`);

    try {
        const res = await fetch(CARTESIA_CFG.endpoint, {
            method: "POST",
            headers: { "Content-Type": "application/json", "X-API-Key": CARTESIA_KEY, "Cartesia-Version": CARTESIA_CFG.version },
            body: JSON.stringify({
                model_id: CARTESIA_CFG.model_id, 
                transcript: text,
                language: isoLang, // Explicit language hint
                voice: { mode: "id", id: "9c7e6604-52c6-424a-9f9f-2c4ad89f3bb9" },
                output_format: CARTESIA_CFG.output_primary, 
                generation_config: CARTESIA_CFG.generation_config
            })
        });

        if (!res.ok) {
            const errText = await res.text();
            throw new Error(`TTS API Error ${res.status}: ${errText}`);
        }

        const blob = await res.blob();
        ttsAudio.src = URL.createObjectURL(blob);
        
        // Play with error handling
        try {
            await ttsAudio.play();
        } catch(playErr) {
            console.error("Audio Playback Failed (Autoplay blocked?)", playErr);
            // ui.toast.textContent = "Tap to enable audio";
            // ui.toast.classList.add("show");
        }

        await new Promise(r => { 
            ttsAudio.onended = r; 
            // Fallback timeout in case onended doesn't fire
            setTimeout(r, (text.length * 100) + 2000); 
        });

    } catch(e) { 
        console.error("TTS Process Error", e);
        ui.toast.textContent = "TTS Error: " + e.message.substring(0, 20);
        ui.toast.classList.add("show");
        setTimeout(() => ui.toast.classList.remove("show"), 3000);
    }
    
    ui.recvText.textContent = "Receiver Idle";
    ui.recvDot.className = "dot active";
    ttsBusy = false;
    processTTS();
}

// --- DEEPGRAM CONFIGURATION ---
const DEEPGRAM_KEY = "52c4137114e2f86597c78326be7b512daae7f266";
let dgSocket = null;
let mediaRecorder = null;
let listening = false;

// We'll use a circular buffer/queue for audio chunks? 
// No, MediaRecorder directly slices chunks.

async function startBroadcasting() {
    if (listening) return stopBroadcasting();
    
    // 1. Get Mic Stream
    let stream;
    try {
        const deviceId = ui.micSelect.value;
        const constraints = { audio: deviceId === 'default' ? true : { deviceId: { exact: deviceId } } };
        
        try {
            stream = await navigator.mediaDevices.getUserMedia(constraints);
        } catch(innerErr) {
            console.warn("Selected mic failed, fallback to default...", innerErr);
            if(deviceId !== 'default') {
                stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                ui.toast.textContent = "Switched to Default Mic";
                ui.toast.classList.add("show");
                setTimeout(() => ui.toast.classList.remove("show"), 3000);
            } else throw innerErr;
        }
        initSourceViz(stream);
    } catch(e) {
        console.error("Mic Access Error", e);
        return alert(`Microphone Error: ${e.name}\n${e.message}\nCheck permissions.`);
    }

    listening = true;
    ui.floorText.textContent = "Connecting...";
    ui.floorDot.className = "dot receiving"; // yellow while connecting
    ui.broadcastBtn.textContent = "Connecting...";
    ui.broadcastBtn.className = "btn btn-outline";

    // 2. Open Deepgram WebSocket
    // Using nova-3 and smart_formatting
    const dgUrl = `wss://api.deepgram.com/v1/listen?smart_format=true&model=nova-3&interim_results=true&language=${ui.srcLang.value || 'en-US'}`;
    dgSocket = new WebSocket(dgUrl, ['token', DEEPGRAM_KEY]);

    dgSocket.onopen = () => {
        ui.floorText.textContent = "On Air";
        ui.floorDot.className = "dot active";
        ui.broadcastBtn.textContent = "Stop Broadcasting";
        ui.broadcastBtn.className = "btn btn-red";
        ui.liveCaptionBar.textContent = "Listening...";
        
        // 3. Start Recording & Streaming
        startStreamingAudio(stream);
    };

    dgSocket.onmessage = async (msg) => {
        const data = JSON.parse(msg.data);
        if (data.channel && data.channel.alternatives && data.channel.alternatives[0]) {
            const alt = data.channel.alternatives[0];
            const transcript = alt.transcript;
            
            if (transcript && data.is_final) {
                // Final Result: Validate & Translate
                const txt = transcript.trim();
                if (txt) {
                    const tl = ui.tgtLang.value.split('-')[0]; // Simple language code from locale
                    // Use Google Translate (Free Tier / Hack)
                    // In production, use a real backend proxy!
                    const url = `https://translate.googleapis.com/translate_a/single?client=gtx&sl=auto&tl=${tl}&dt=t&q=${encodeURIComponent(txt)}`;
                    try {
                        const r = await fetch(url);
                        const d = await r.json();
                        const trans = d[0].map(x => x[0]).join("");
                        
                        if(window.broadcastTranslation) {
                            window.broadcastTranslation(txt, trans, "auto", tl);
                        }
                    } catch(err) { console.error("Translation Error", err); }
                }
            } else {
                // Interim Result
                ui.liveCaptionBar.textContent = transcript || "Listening...";
            }
        }
    };

    dgSocket.onerror = (e) => {
        console.error("Deepgram WebSocket Error", e);
    };

    dgSocket.onclose = () => {
        if(listening) stopBroadcasting(); // Unexpected close
    };
}

function startStreamingAudio(stream) {
    if (!MediaRecorder.isTypeSupported('audio/webm')) {
        return alert("Browser not supported (Audio/WebM)");
    }
    mediaRecorder = new MediaRecorder(stream, { mimeType: 'audio/webm' });
    mediaRecorder.addEventListener('dataavailable', event => {
        if (event.data.size > 0 && dgSocket && dgSocket.readyState === 1) {
            dgSocket.send(event.data);
        }
    });
    mediaRecorder.start(250); // Send chunk every 250ms
}

function stopBroadcasting() {
    listening = false;
    
    // Stop Recorder
    if(mediaRecorder && mediaRecorder.state !== 'inactive') mediaRecorder.stop();
    mediaRecorder = null;

    // Close Socket
    if(dgSocket) dgSocket.close();
    dgSocket = null;

    // UI Reset
    ui.floorText.textContent = "Mic Off";
    ui.floorDot.className = "dot";
    ui.broadcastBtn.textContent = "Start Broadcasting";
    ui.broadcastBtn.className = "btn btn-green";
    ui.liveCaptionBar.textContent = "";

    if (inputCtx) inputCtx.close();
}

ui.broadcastBtn.addEventListener('click', startBroadcasting);

const LANGUAGES = [
  { code: 'auto', name: 'Auto Detect', flag: 'âœ¨' },

  // --- English World ---
  { code: 'en-US', name: 'English (United States)', flag: 'ğŸ‡ºğŸ‡¸' },
  { code: 'en-GB', name: 'English (United Kingdom)', flag: 'ğŸ‡¬ğŸ‡§' },
  { code: 'en-CA', name: 'English (Canada)', flag: 'ğŸ‡¨ğŸ‡¦' },
  { code: 'en-AU', name: 'English (Australia)', flag: 'ğŸ‡¦ğŸ‡º' },
  { code: 'en-NZ', name: 'English (New Zealand)', flag: 'ğŸ‡³ğŸ‡¿' },
  { code: 'en-IE', name: 'English (Ireland)', flag: 'ğŸ‡®ğŸ‡ª' },
  { code: 'en-ZA', name: 'English (South Africa)', flag: 'ğŸ‡¿ğŸ‡¦' },
  { code: 'en-IN', name: 'English (India)', flag: 'ğŸ‡®ğŸ‡³' },
  { code: 'en-PH', name: 'English (Philippines)', flag: 'ğŸ‡µğŸ‡­' },
  { code: 'en-SG', name: 'English (Singapore)', flag: 'ğŸ‡¸ğŸ‡¬' },
  { code: 'en-MY', name: 'English (Malaysia)', flag: 'ğŸ‡²ğŸ‡¾' },
  { code: 'en-HK', name: 'English (Hong Kong)', flag: 'ğŸ‡­ğŸ‡°' },
  { code: 'en-KE', name: 'English (Kenya)', flag: 'ğŸ‡°ğŸ‡ª' },
  { code: 'en-GH', name: 'English (Ghana)', flag: 'ğŸ‡¬ğŸ‡­' },
  { code: 'en-NG', name: 'English (Nigeria)', flag: 'ğŸ‡³ğŸ‡¬' },
  { code: 'en-PK', name: 'English (Pakistan)', flag: 'ğŸ‡µğŸ‡°' },

  // --- Spanish World ---
  { code: 'es-ES', name: 'Spanish (Spain)', flag: 'ğŸ‡ªğŸ‡¸' },
  { code: 'es-MX', name: 'Spanish (Mexico)', flag: 'ğŸ‡²ğŸ‡½' },
  { code: 'es-US', name: 'Spanish (United States)', flag: 'ğŸ‡ºğŸ‡¸' },
  { code: 'es-AR', name: 'Spanish (Argentina)', flag: 'ğŸ‡¦ğŸ‡·' },
  { code: 'es-BO', name: 'Spanish (Bolivia)', flag: 'ğŸ‡§ğŸ‡´' },
  { code: 'es-CL', name: 'Spanish (Chile)', flag: 'ğŸ‡¨ğŸ‡±' },
  { code: 'es-CO', name: 'Spanish (Colombia)', flag: 'ğŸ‡¨ğŸ‡´' },
  { code: 'es-CR', name: 'Spanish (Costa Rica)', flag: 'ğŸ‡¨ğŸ‡·' },
  { code: 'es-CU', name: 'Spanish (Cuba)', flag: 'ğŸ‡¨ğŸ‡º' },
  { code: 'es-DO', name: 'Spanish (Dominican Republic)', flag: 'ğŸ‡©ğŸ‡´' },
  { code: 'es-EC', name: 'Spanish (Ecuador)', flag: 'ğŸ‡ªğŸ‡¨' },
  { code: 'es-SV', name: 'Spanish (El Salvador)', flag: 'ğŸ‡¸ğŸ‡»' },
  { code: 'es-GT', name: 'Spanish (Guatemala)', flag: 'ğŸ‡¬ğŸ‡¹' },
  { code: 'es-HN', name: 'Spanish (Honduras)', flag: 'ğŸ‡­ğŸ‡³' },
  { code: 'es-NI', name: 'Spanish (Nicaragua)', flag: 'ğŸ‡³ğŸ‡®' },
  { code: 'es-PA', name: 'Spanish (Panama)', flag: 'ğŸ‡µğŸ‡¦' },
  { code: 'es-PY', name: 'Spanish (Paraguay)', flag: 'ğŸ‡µğŸ‡¾' },
  { code: 'es-PE', name: 'Spanish (Peru)', flag: 'ğŸ‡µğŸ‡ª' },
  { code: 'es-PR', name: 'Spanish (Puerto Rico)', flag: 'ğŸ‡µğŸ‡·' },
  { code: 'es-UY', name: 'Spanish (Uruguay)', flag: 'ğŸ‡ºğŸ‡¾' },
  { code: 'es-VE', name: 'Spanish (Venezuela)', flag: 'ğŸ‡»ğŸ‡ª' },

  // --- Portuguese World ---
  { code: 'pt-PT', name: 'Portuguese (Portugal)', flag: 'ğŸ‡µğŸ‡¹' },
  { code: 'pt-BR', name: 'Portuguese (Brazil)', flag: 'ğŸ‡§ğŸ‡·' },
  { code: 'pt-AO', name: 'Portuguese (Angola)', flag: 'ğŸ‡¦ğŸ‡´' },
  { code: 'pt-MZ', name: 'Portuguese (Mozambique)', flag: 'ğŸ‡²ğŸ‡¿' },

  // --- French World ---
  { code: 'fr-FR', name: 'French (France)', flag: 'ğŸ‡«ğŸ‡·' },
  { code: 'fr-CA', name: 'French (Canada)', flag: 'ğŸ‡¨ğŸ‡¦' },
  { code: 'fr-BE', name: 'French (Belgium)', flag: 'ğŸ‡§ğŸ‡ª' },
  { code: 'fr-CH', name: 'French (Switzerland)', flag: 'ğŸ‡¨ğŸ‡­' },
  { code: 'fr-LU', name: 'French (Luxembourg)', flag: 'ğŸ‡±ğŸ‡º' },
  { code: 'fr-SN', name: 'French (Senegal)', flag: 'ğŸ‡¸ğŸ‡³' },
  { code: 'fr-CI', name: "French (CÃ´te d'Ivoire)", flag: 'ğŸ‡¨ğŸ‡®' },

  // --- Germanic (Core) ---
  { code: 'de-DE', name: 'German (Germany)', flag: 'ğŸ‡©ğŸ‡ª' },
  { code: 'de-AT', name: 'German (Austria)', flag: 'ğŸ‡¦ğŸ‡¹' },
  { code: 'de-CH', name: 'German (Switzerland)', flag: 'ğŸ‡¨ğŸ‡­' },
  { code: 'nl-NL', name: 'Dutch (Netherlands)', flag: 'ğŸ‡³ğŸ‡±' },
  { code: 'nl-BE', name: 'Dutch (Belgium / Flemish Standard)', flag: 'ğŸ‡§ğŸ‡ª' },

  // --- Belgium Regional Languages / Dialects ---
  { code: 'vls-BE', name: 'West Flemish (Belgium)', flag: 'ğŸ‡§ğŸ‡ª' },
  { code: 'zea-BE', name: 'Zeelandic (Belgium)', flag: 'ğŸ‡§ğŸ‡ª' },
  { code: 'lim-BE', name: 'Limburgish (Belgium)', flag: 'ğŸ‡§ğŸ‡ª' },
  { code: 'wa-BE', name: 'Walloon (Belgium)', flag: 'ğŸ‡§ğŸ‡ª' },
  { code: 'de-BE', name: 'German (Belgium)', flag: 'ğŸ‡§ğŸ‡ª' },
  { code: 'pcd-BE', name: 'Picard (Belgium)', flag: 'ğŸ‡§ğŸ‡ª' },

  // --- African Regional Languages ---
  { code: 'fr-CM', name: 'French (Cameroon)', flag: 'ğŸ‡¨ğŸ‡²' },
  { code: 'en-CM', name: 'English (Cameroon)', flag: 'ğŸ‡¨ğŸ‡²' },
  { code: 'byv-CM', name: 'Medumba (Cameroon)', flag: 'ğŸ‡¨ğŸ‡²' },
  { code: 'wo-SN', name: 'Wolof (Senegal)', flag: 'ğŸ‡¸ğŸ‡³' },

  // --- Philippines Regional Languages ---
  { code: 'fil-PH', name: 'Filipino (Philippines)', flag: 'ğŸ‡µğŸ‡­' },
  { code: 'tl-PH', name: 'Tagalog (Philippines)', flag: 'ğŸ‡µğŸ‡­' },
  { code: 'ceb-PH', name: 'Cebuano (Philippines)', flag: 'ğŸ‡µğŸ‡­' },
  { code: 'ilo-PH', name: 'Ilocano (Philippines)', flag: 'ğŸ‡µğŸ‡­' },
  { code: 'hil-PH', name: 'Hiligaynon (Philippines)', flag: 'ğŸ‡µğŸ‡­' },
  { code: 'war-PH', name: 'Waray (Philippines)', flag: 'ğŸ‡µğŸ‡­' },

  // --- Italy & Neighbors ---
  { code: 'it-IT', name: 'Italian (Italy)', flag: 'ğŸ‡®ğŸ‡¹' },
  { code: 'it-CH', name: 'Italian (Switzerland)', flag: 'ğŸ‡¨ğŸ‡­' },
  { code: 'rm-CH', name: 'Romansh (Switzerland)', flag: 'ğŸ‡¨ğŸ‡­' },

  // --- Nordics ---
  { code: 'sv-SE', name: 'Swedish', flag: 'ğŸ‡¸ğŸ‡ª' },
  { code: 'da-DK', name: 'Danish', flag: 'ğŸ‡©ğŸ‡°' },
  { code: 'nb-NO', name: 'Norwegian BokmÃ¥l', flag: 'ğŸ‡³ğŸ‡´' },
  { code: 'nn-NO', name: 'Norwegian Nynorsk', flag: 'ğŸ‡³ğŸ‡´' },
  { code: 'fi-FI', name: 'Finnish', flag: 'ğŸ‡«ğŸ‡®' },
  { code: 'is-IS', name: 'Icelandic', flag: 'ğŸ‡®ğŸ‡¸' },
  { code: 'fo-FO', name: 'Faroese', flag: 'ğŸ‡«ğŸ‡´' },

  // --- Western & Central Europe ---
  { code: 'ga-IE', name: 'Irish', flag: 'ğŸ‡®ğŸ‡ª' },
  { code: 'gd-GB', name: 'Scottish Gaelic', flag: 'ğŸ´' },
  { code: 'cy-GB', name: 'Welsh', flag: 'ğŸ´' },
  { code: 'br-FR', name: 'Breton', flag: 'ğŸ‡«ğŸ‡·' },
  { code: 'eu-ES', name: 'Basque', flag: 'ğŸ‡ªğŸ‡¸' },
  { code: 'ca-ES', name: 'Catalan', flag: 'ğŸ‡ªğŸ‡¸' },
  { code: 'gl-ES', name: 'Galician', flag: 'ğŸ‡ªğŸ‡¸' },
  { code: 'oc-FR', name: 'Occitan', flag: 'ğŸ‡«ğŸ‡·' },
  { code: 'lb-LU', name: 'Luxembourgish', flag: 'ğŸ‡±ğŸ‡º' },
  { code: 'mt-MT', name: 'Maltese', flag: 'ğŸ‡²ğŸ‡¹' },

  // --- Balkans & Eastern Europe ---
  { code: 'pl-PL', name: 'Polish', flag: 'ğŸ‡µğŸ‡±' },
  { code: 'cs-CZ', name: 'Czech', flag: 'ğŸ‡¨ğŸ‡¿' },
  { code: 'sk-SK', name: 'Slovak', flag: 'ğŸ‡¸ğŸ‡°' },
  { code: 'hu-HU', name: 'Hungarian', flag: 'ğŸ‡­ğŸ‡º' },
  { code: 'ro-RO', name: 'Romanian', flag: 'ğŸ‡·ğŸ‡´' },
  { code: 'bg-BG', name: 'Bulgarian', flag: 'ğŸ‡§ğŸ‡¬' },
  { code: 'sl-SI', name: 'Slovenian', flag: 'ğŸ‡¸ğŸ‡®' },
  { code: 'hr-HR', name: 'Croatian', flag: 'ğŸ‡­ğŸ‡·' },
  { code: 'sr-RS', name: 'Serbian (Serbia)', flag: 'ğŸ‡·ğŸ‡¸' },
  { code: 'bs-BA', name: 'Bosnian', flag: 'ğŸ‡§ğŸ‡¦' },
  { code: 'mk-MK', name: 'Macedonian', flag: 'ğŸ‡²ğŸ‡°' },
  { code: 'sq-AL', name: 'Albanian', flag: 'ğŸ‡¦ğŸ‡±' },
  { code: 'el-GR', name: 'Greek', flag: 'ğŸ‡¬ğŸ‡·' },
  { code: 'ru-RU', name: 'Russian', flag: 'ğŸ‡·ğŸ‡º' },
  { code: 'uk-UA', name: 'Ukrainian', flag: 'ğŸ‡ºğŸ‡¦' },
  { code: 'be-BY', name: 'Belarusian', flag: 'ğŸ‡§ğŸ‡¾' },
  { code: 'et-EE', name: 'Estonian', flag: 'ğŸ‡ªğŸ‡ª' },
  { code: 'lv-LV', name: 'Latvian', flag: 'ğŸ‡±ğŸ‡»' },
  { code: 'lt-LT', name: 'Lithuanian', flag: 'ğŸ‡±ğŸ‡¹' },

  // --- Caucasus & Central Asia ---
  { code: 'ka-GE', name: 'Georgian', flag: 'ğŸ‡¬ğŸ‡ª' },
  { code: 'hy-AM', name: 'Armenian', flag: 'ğŸ‡¦ğŸ‡²' },
  { code: 'az-AZ', name: 'Azerbaijani', flag: 'ğŸ‡¦ğŸ‡¿' },
  { code: 'kk-KZ', name: 'Kazakh', flag: 'ğŸ‡°ğŸ‡¿' },
  { code: 'ky-KG', name: 'Kyrgyz', flag: 'ğŸ‡°ğŸ‡¬' },
  { code: 'uz-UZ', name: 'Uzbek', flag: 'ğŸ‡ºğŸ‡¿' },
  { code: 'tk-TM', name: 'Turkmen', flag: 'ğŸ‡¹ğŸ‡²' },
  { code: 'tg-TJ', name: 'Tajik', flag: 'ğŸ‡¹ğŸ‡¯' },

  // --- Middle East (Semitic/Iranic/Turkic) ---
  { code: 'tr-TR', name: 'Turkish', flag: 'ğŸ‡¹ğŸ‡·' },
  { code: 'he-IL', name: 'Hebrew', flag: 'ğŸ‡®ğŸ‡±' },
  { code: 'fa-IR', name: 'Persian (Iran)', flag: 'ğŸ‡®ğŸ‡·' },
  { code: 'fa-AF', name: 'Dari (Afghanistan)', flag: 'ğŸ‡¦ğŸ‡«' },
  { code: 'ps-AF', name: 'Pashto (Afghanistan)', flag: 'ğŸ‡¦ğŸ‡«' },
  { code: 'ku-TR', name: 'Kurdish (Kurmanji)', flag: 'ğŸ‡¹ğŸ‡·' },
  { code: 'ckb-IQ', name: 'Kurdish (Sorani)', flag: 'ğŸ‡®ğŸ‡¶' },

  // Arabic regional variants (common)
  { code: 'ar-SA', name: 'Arabic (Saudi Arabia)', flag: 'ğŸ‡¸ğŸ‡¦' },
  { code: 'ar-AE', name: 'Arabic (UAE)', flag: 'ğŸ‡¦ğŸ‡ª' },
  { code: 'ar-QA', name: 'Arabic (Qatar)', flag: 'ğŸ‡¶ğŸ‡¦' },
  { code: 'ar-KW', name: 'Arabic (Kuwait)', flag: 'ğŸ‡°ğŸ‡¼' },
  { code: 'ar-BH', name: 'Arabic (Bahrain)', flag: 'ğŸ‡§ğŸ‡­' },
  { code: 'ar-OM', name: 'Arabic (Oman)', flag: 'ğŸ‡´ğŸ‡²' },
  { code: 'ar-YE', name: 'Arabic (Yemen)', flag: 'ğŸ‡¾ğŸ‡ª' },
  { code: 'ar-IQ', name: 'Arabic (Iraq)', flag: 'ğŸ‡®ğŸ‡¶' },
  { code: 'ar-JO', name: 'Arabic (Jordan)', flag: 'ğŸ‡¯ğŸ‡´' },
  { code: 'ar-LB', name: 'Arabic (Lebanon)', flag: 'ğŸ‡±ğŸ‡§' },
  { code: 'ar-SY', name: 'Arabic (Syria)', flag: 'ğŸ‡¸ğŸ‡¾' },
  { code: 'ar-EG', name: 'Arabic (Egypt)', flag: 'ğŸ‡ªğŸ‡¬' },
  { code: 'ar-SD', name: 'Arabic (Sudan)', flag: 'ğŸ‡¸ğŸ‡©' },
  { code: 'ar-DZ', name: 'Arabic (Algeria)', flag: 'ğŸ‡©ğŸ‡¿' },
  { code: 'ar-TN', name: 'Arabic (Tunisia)', flag: 'ğŸ‡¹ğŸ‡³' },
  { code: 'ar-MA', name: 'Arabic (Morocco)', flag: 'ğŸ‡²ğŸ‡¦' },

  // --- South Asia ---
  { code: 'hi-IN', name: 'Hindi', flag: 'ğŸ‡®ğŸ‡³' },
  { code: 'ur-PK', name: 'Urdu (Pakistan)', flag: 'ğŸ‡µğŸ‡°' },
  { code: 'ur-IN', name: 'Urdu (India)', flag: 'ğŸ‡®ğŸ‡³' },
  { code: 'bn-BD', name: 'Bengali (Bangladesh)', flag: 'ğŸ‡§ğŸ‡©' },
  { code: 'bn-IN', name: 'Bengali (India)', flag: 'ğŸ‡®ğŸ‡³' },
  { code: 'pa-IN', name: 'Punjabi (India)', flag: 'ğŸ‡®ğŸ‡³' },
  { code: 'pa-PK', name: 'Punjabi (Pakistan)', flag: 'ğŸ‡µğŸ‡°' },
  { code: 'gu-IN', name: 'Gujarati', flag: 'ğŸ‡®ğŸ‡³' },
  { code: 'mr-IN', name: 'Marathi', flag: 'ğŸ‡®ğŸ‡³' },
  { code: 'ta-IN', name: 'Tamil (India)', flag: 'ğŸ‡®ğŸ‡³' },
  { code: 'ta-LK', name: 'Tamil (Sri Lanka)', flag: 'ğŸ‡±ğŸ‡°' },
  { code: 'te-IN', name: 'Telugu', flag: 'ğŸ‡®ğŸ‡³' },
  { code: 'kn-IN', name: 'Kannada', flag: 'ğŸ‡®ğŸ‡³' },
  { code: 'ml-IN', name: 'Malayalam', flag: 'ğŸ‡®ğŸ‡³' },
  { code: 'or-IN', name: 'Odia', flag: 'ğŸ‡®ğŸ‡³' },
  { code: 'as-IN', name: 'Assamese', flag: 'ğŸ‡®ğŸ‡³' },
  { code: 'ne-NP', name: 'Nepali', flag: 'ğŸ‡³ğŸ‡µ' },
  { code: 'si-LK', name: 'Sinhala', flag: 'ğŸ‡±ğŸ‡°' },
  { code: 'my-MM', name: 'Burmese (Myanmar)', flag: 'ğŸ‡²ğŸ‡²' },

  // --- East Asia (Sino-Tibetan, Japonic, Koreanic) ---
  { code: 'zh-Hans', name: 'Chinese (Simplified)', flag: 'ğŸ‡¨ğŸ‡³' },
  { code: 'zh-Hant', name: 'Chinese (Traditional)', flag: 'ğŸ‡¹ğŸ‡¼' },
  { code: 'zh-CN', name: 'Chinese (Simplified, China)', flag: 'ğŸ‡¨ğŸ‡³' },
  { code: 'zh-SG', name: 'Chinese (Simplified, Singapore)', flag: 'ğŸ‡¸ğŸ‡¬' },
  { code: 'zh-TW', name: 'Chinese (Traditional, Taiwan)', flag: 'ğŸ‡¹ğŸ‡¼' },
  { code: 'zh-HK', name: 'Chinese (Traditional, Hong Kong)', flag: 'ğŸ‡­ğŸ‡°' },
  { code: 'yue-HK', name: 'Cantonese (Hong Kong)', flag: 'ğŸ‡­ğŸ‡°' },
  { code: 'zh-MO', name: 'Chinese (Traditional, Macau)', flag: 'ğŸ‡²ğŸ‡´' },
  { code: 'ja-JP', name: 'Japanese', flag: 'ğŸ‡¯ğŸ‡µ' },
  { code: 'ko-KR', name: 'Korean', flag: 'ğŸ‡°ğŸ‡·' },

  // --- Southeast Asia ---
  { code: 'id-ID', name: 'Indonesian', flag: 'ğŸ‡®ğŸ‡©' },
  { code: 'jv-ID', name: 'Javanese', flag: 'ğŸ‡®ğŸ‡©' },
  { code: 'su-ID', name: 'Sundanese', flag: 'ğŸ‡®ğŸ‡©' },
  { code: 'ms-MY', name: 'Malay (Malaysia)', flag: 'ğŸ‡²ğŸ‡¾' },
  { code: 'ms-SG', name: 'Malay (Singapore)', flag: 'ğŸ‡¸ğŸ‡¬' },
  { code: 'ms-BN', name: 'Malay (Brunei)', flag: 'ğŸ‡§ğŸ‡³' },
  { code: 'vi-VN', name: 'Vietnamese', flag: 'ğŸ‡»ğŸ‡³' },
  { code: 'th-TH', name: 'Thai', flag: 'ğŸ‡¹ğŸ‡­' },
  { code: 'km-KH', name: 'Khmer (Cambodia)', flag: 'ğŸ‡°ğŸ‡­' },
  { code: 'lo-LA', name: 'Lao', flag: 'ğŸ‡±ğŸ‡¦' },

  // --- Philippines (Major Regional Languages) ---
  { code: 'bcl-PH', name: 'Central Bikol', flag: 'ğŸ‡µğŸ‡­' },
  { code: 'pam-PH', name: 'Kapampangan', flag: 'ğŸ‡µğŸ‡­' },
  { code: 'pag-PH', name: 'Pangasinan', flag: 'ğŸ‡µğŸ‡­' },
  { code: 'mnd-PH', name: 'Maguindanao', flag: 'ğŸ‡µğŸ‡­' },
  { code: 'mrw-PH', name: 'Maranao', flag: 'ğŸ‡µğŸ‡­' },
  { code: 'tsg-PH', name: 'Tausug', flag: 'ğŸ‡µğŸ‡­' },
  { code: 'cbk-PH', name: 'Chavacano', flag: 'ğŸ‡µğŸ‡­' },
  { code: 'bto-PH', name: 'Rinconada Bikol', flag: 'ğŸ‡µğŸ‡­' },
  { code: 'krj-PH', name: 'Kinaray-a', flag: 'ğŸ‡µğŸ‡­' },
  { code: 'akl-PH', name: 'Aklanon', flag: 'ğŸ‡µğŸ‡­' },
  { code: 'msb-PH', name: 'MasbateÃ±o', flag: 'ğŸ‡µğŸ‡­' },
  { code: 'sur-PH', name: 'Surigaonon', flag: 'ğŸ‡µğŸ‡­' },
  { code: 'tl-mix', name: 'Taglish (Tagalog-English Mix)', flag: 'ğŸ‡µğŸ‡­' },

  // --- Africa (Pan) ---
  { code: 'sw-KE', name: 'Swahili (Kenya)', flag: 'ğŸ‡°ğŸ‡ª' },
  { code: 'sw-TZ', name: 'Swahili (Tanzania)', flag: 'ğŸ‡¹ğŸ‡¿' },
  { code: 'am-ET', name: 'Amharic', flag: 'ğŸ‡ªğŸ‡¹' },
  { code: 'ti-ER', name: 'Tigrinya (Eritrea)', flag: 'ğŸ‡ªğŸ‡·' },
  { code: 'ti-ET', name: 'Tigrinya (Ethiopia)', flag: 'ğŸ‡ªğŸ‡¹' },
  { code: 'ha-NG', name: 'Hausa (Nigeria)', flag: 'ğŸ‡³ğŸ‡¬' },
  { code: 'yo-NG', name: 'Yoruba (Nigeria)', flag: 'ğŸ‡³ğŸ‡¬' },
  { code: 'ig-NG', name: 'Igbo (Nigeria)', flag: 'ğŸ‡³ğŸ‡¬' },
  { code: 'zu-ZA', name: 'Zulu (South Africa)', flag: 'ğŸ‡¿ğŸ‡¦' },
  { code: 'xh-ZA', name: 'Xhosa (South Africa)', flag: 'ğŸ‡¿ğŸ‡¦' },
  { code: 'st-LS', name: 'Sesotho', flag: 'ğŸ‡±ğŸ‡¸' },
  { code: 'sn-ZW', name: 'Shona', flag: 'ğŸ‡¿ğŸ‡¼' },
  { code: 'so-SO', name: 'Somali', flag: 'ğŸ‡¸ğŸ‡´' },
  { code: 'rw-RW', name: 'Kinyarwanda', flag: 'ğŸ‡·ğŸ‡¼' },
  { code: 'rn-BI', name: 'Kirundi', flag: 'ğŸ‡§ğŸ‡®' },
  { code: 'mg-MG', name: 'Malagasy', flag: 'ğŸ‡²ğŸ‡¬' },
  { code: 'ny-MW', name: 'Chichewa', flag: 'ğŸ‡²ğŸ‡¼' },
  { code: 'ts-ZA', name: 'Xitsonga', flag: 'ğŸ‡¿ğŸ‡¦' },
  { code: 'tn-ZA', name: 'Setswana', flag: 'ğŸ‡¿ğŸ‡¦' },
  { code: 'ff-SN', name: 'Fula (Pulaar / Fulfulde)', flag: 'ğŸ‡¸ğŸ‡³' },

  // --- Cameroon (Expanded) ---
  { code: 'wes-CM', name: 'Cameroon Pidgin', flag: 'ğŸ‡¨ğŸ‡²' },
  { code: 'ewo-CM', name: 'Ewondo', flag: 'ğŸ‡¨ğŸ‡²' },
  { code: 'dua-CM', name: 'Duala', flag: 'ğŸ‡¨ğŸ‡²' },
  { code: 'bas-CM', name: 'Basaa', flag: 'ğŸ‡¨ğŸ‡²' },
  { code: 'bum-CM', name: 'Bulu', flag: 'ğŸ‡¨ğŸ‡²' },
  { code: 'bkm-CM', name: 'Kom (Cameroon)', flag: 'ğŸ‡¨ğŸ‡²' },
  { code: 'fub-CM', name: 'Fulfulde (Cameroon)', flag: 'ğŸ‡¨ğŸ‡²' },

  // --- Americas (Non-English) ---
  { code: 'fr-HT', name: 'Haitian French', flag: 'ğŸ‡­ğŸ‡¹' },
  { code: 'ht-HT', name: 'Haitian Creole', flag: 'ğŸ‡­ğŸ‡¹' },
  { code: 'qu-PE', name: 'Quechua (Peru)', flag: 'ğŸ‡µğŸ‡ª' },
  { code: 'gn-PY', name: 'Guarani (Paraguay)', flag: 'ğŸ‡µğŸ‡¾' },
  { code: 'ay-BO', name: 'Aymara (Bolivia)', flag: 'ğŸ‡§ğŸ‡´' },

  // --- East Africa / Horn ---
  { code: 'om-ET', name: 'Oromo (Ethiopia)', flag: 'ğŸ‡ªğŸ‡¹' },

  // --- Oceania ---
  { code: 'mi-NZ', name: 'MÄori (New Zealand)', flag: 'ğŸ‡³ğŸ‡¿' },
  { code: 'sm-WS', name: 'Samoan', flag: 'ğŸ‡¼ğŸ‡¸' },
  { code: 'to-TO', name: 'Tongan', flag: 'ğŸ‡¹ğŸ‡´' },
  { code: 'fj-FJ', name: 'Fijian', flag: 'ğŸ‡«ğŸ‡¯' },
  { code: 'tpi-PG', name: 'Tok Pisin', flag: 'ğŸ‡µğŸ‡¬' },

  // --- Indigenous Americas (JW.org subset) ---
  { code: 'yua-MX', name: 'Maya (Yucatec)', flag: 'ğŸ‡²ğŸ‡½' },
  { code: 'nah-MX', name: 'Nahuatl (Central)', flag: 'ğŸ‡²ğŸ‡½' },
  { code: 'quc-GT', name: "K'iche'", flag: 'ğŸ‡¬ğŸ‡¹' },
  { code: 'mam-GT', name: 'Mam', flag: 'ğŸ‡¬ğŸ‡¹' },
  { code: 'kek-GT', name: "Q'eqchi'", flag: 'ğŸ‡¬ğŸ‡¹' },
  { code: 'cak-GT', name: 'Kaqchikel', flag: 'ğŸ‡¬ğŸ‡¹' },
  { code: 'zap-MX', name: 'Zapotec (Isthmus)', flag: 'ğŸ‡²ğŸ‡½' },
  { code: 'mix-MX', name: 'Mixtec', flag: 'ğŸ‡²ğŸ‡½' },
  { code: 'miq-NI', name: 'Miskito', flag: 'ğŸ‡³ğŸ‡®' },
  { code: 'pap-CW', name: 'Papiamento', flag: 'ğŸ‡¨ğŸ‡¼' },

  // --- African Languages (Expanded) ---
  { code: 'tw-GH', name: 'Twi', flag: 'ğŸ‡¬ğŸ‡­' },
  { code: 'ee-GH', name: 'Ewe', flag: 'ğŸ‡¬ğŸ‡­' },
  { code: 'ln-CD', name: 'Lingala', flag: 'ğŸ‡¨ğŸ‡©' },
  { code: 'lg-UG', name: 'Luganda', flag: 'ğŸ‡ºğŸ‡¬' },
  { code: 'ki-KE', name: 'Kikuyu', flag: 'ğŸ‡°ğŸ‡ª' },
  { code: 'bem-ZM', name: 'Bemba', flag: 'ğŸ‡¿ğŸ‡²' },

  // --- Asia / Other ---
  { code: 'hmn-CN', name: 'Hmong', flag: 'ğŸ‡¨ğŸ‡³' },
  { code: 'rom', name: 'Romani', flag: 'ğŸŒ' },
  { code: 'szl-PL', name: 'Silesian', flag: 'ğŸ‡µğŸ‡±' },

  // --- Constructed / Other ---
  { code: 'eo', name: 'Esperanto', flag: 'ğŸŒ' },
  { code: 'la', name: 'Latin', flag: 'ğŸŒ' },

  // --- JW.org Extended Languages ---
  { code: 'en', name: 'English', flag: 'ğŸŒ' },
  { code: 'ar', name: 'Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©', flag: 'ğŸŒ' },
  { code: 'el', name: 'Î•Î»Î»Î·Î½Î¹ÎºÎ®', flag: 'ğŸŒ' },
  { code: 'ja', name: 'æ—¥æœ¬èª', flag: 'ğŸŒ' },
  { code: 'ko', name: 'í•œêµ­ì–´', flag: 'ğŸŒ' },
  { code: 'ru', name: 'Ñ€ÑƒÑÑĞºĞ¸Ğ¹', flag: 'ğŸŒ' },
  { code: 'sn', name: 'Shona', flag: 'ğŸŒ' },
  { code: 'sr-cyrl', name: 'ÑÑ€Ğ¿ÑĞºĞ¸ (Ñ›Ğ¸Ñ€Ğ¸Ğ»Ğ¸Ñ†Ğ°)', flag: 'ğŸŒ' },
  { code: 'sv', name: 'Svenska', flag: 'ğŸŒ' },
  { code: 'ty', name: 'Tahiti', flag: 'ğŸŒ' },
  { code: 'bci', name: 'Wawle', flag: 'ğŸŒ' },
  { code: 'no', name: 'Norsk', flag: 'ğŸŒ' },
  { code: 'da', name: 'Dansk', flag: 'ğŸŒ' },
  { code: 'nl', name: 'Nederlands', flag: 'ğŸŒ' },
  { code: 'is', name: 'Ã­slenska', flag: 'ğŸŒ' },
  { code: 'tl', name: 'Tagalog', flag: 'ğŸŒ' },
  { code: 'ne', name: 'à¤¨à¥‡à¤ªà¤¾à¤²à¥€', flag: 'ğŸŒ' },
  { code: 'zpa', name: 'diitza', flag: 'ğŸŒ' },
  { code: 'hu', name: 'magyar', flag: 'ğŸŒ' },
  { code: 'fo', name: 'FÃ¸royskt', flag: 'ğŸŒ' },
  { code: 'sl', name: 'slovenÅ¡Äina', flag: 'ğŸŒ' },
  { code: 'sg', name: 'Sango', flag: 'ğŸŒ' },
  { code: 'hy', name: 'Õ€Õ¡ÕµÕ¥Ö€Õ¥Õ¶', flag: 'ğŸŒ' },
  { code: 'kj', name: 'Oshikwanyama', flag: 'ğŸŒ' },
  { code: 'guw', name: 'Gungbe', flag: 'ğŸŒ' },
  { code: 'fi', name: 'suomi', flag: 'ğŸŒ' },
  { code: 'sm', name: 'Faa-Samoa', flag: 'ğŸŒ' },
  { code: 'xh', name: 'IsiXhosa', flag: 'ğŸŒ' },
  { code: 'ceb', name: 'Cebuano', flag: 'ğŸŒ' },
  { code: 'mg', name: 'Malagasy', flag: 'ğŸŒ' },
  { code: 'efi', name: 'EfiÌ£k', flag: 'ğŸŒ' },
  { code: 'sw', name: 'Kiswahili', flag: 'ğŸŒ' },
  { code: 'ny', name: 'Chichewa', flag: 'ğŸŒ' },
  { code: 'ilo', name: 'Iloko', flag: 'ğŸŒ' },
  { code: 'ka', name: 'áƒ¥áƒáƒ áƒ—áƒ£áƒšáƒ˜', flag: 'ğŸŒ' },
  { code: 'ml', name: 'à´®à´²à´¯à´¾à´³à´‚', flag: 'ğŸŒ' },
  { code: 'ig', name: 'Igbo', flag: 'ğŸŒ' },
  { code: 'gaa', name: 'Ga', flag: 'ğŸŒ' },
  { code: 'ti', name: 'á‰µáŒáˆ­áŠ›', flag: 'ğŸŒ' },
  { code: 'hil', name: 'Hiligaynon', flag: 'ğŸŒ' },
  { code: 'loz', name: 'Silozi', flag: 'ğŸŒ' },
  { code: 'tum', name: 'Chitumbuka', flag: 'ğŸŒ' },
  { code: 'uz-cyrl', name: 'ÑĞ·Ğ±ĞµĞºÑ‡Ğ°', flag: 'ğŸŒ' },
  { code: 'run', name: 'Ikirundi', flag: 'ğŸŒ' },
  { code: 'ts', name: 'Xitsonga', flag: 'ğŸŒ' },
  { code: 'nso', name: 'Sepedi', flag: 'ğŸŒ' },
  { code: 'ky', name: 'ĞºÑ‹Ñ€Ğ³Ñ‹Ğ·', flag: 'ğŸŒ' },
  { code: 'uk', name: 'ÑƒĞºÑ€Ğ°Ñ—Ğ½ÑÑŒĞºĞ°', flag: 'ğŸŒ' },
  { code: 'de', name: 'Deutsch', flag: 'ğŸŒ' },
  { code: 'az', name: 'AzÉ™rbaycan', flag: 'ğŸŒ' },
  { code: 'vi', name: 'Viá»‡t', flag: 'ğŸŒ' },
  { code: 'cmn-hant', name: 'ä¸­æ–‡ç¹é«”ï¼ˆåœ‹èªï¼‰', flag: 'ğŸŒ' },
  { code: 'az-cyrl', name: 'AĞ·Ó™Ñ€Ğ±Ğ°Ñ˜Ò¹Ğ°Ğ½ (ĞºĞ¸Ñ€Ğ¸Ğ» Ó™Ğ»Ğ¸Ñ„Ğ±Ğ°ÑÑ‹)', flag: 'ğŸŒ' },
  { code: 'cs', name: 'ÄeÅ¡tina', flag: 'ğŸŒ' },
  { code: 'zu', name: 'IsiZulu', flag: 'ğŸŒ' },
  { code: 'it', name: 'Italiano', flag: 'ğŸŒ' },
  { code: 'id', name: 'Indonesia', flag: 'ğŸŒ' },
  { code: 'st', name: 'Sesotho (Lesotho)', flag: 'ğŸŒ' },
  { code: 'ta', name: 'à®¤à®®à®¿à®´à¯', flag: 'ğŸŒ' },
  { code: 'si', name: 'à·ƒà·’à¶‚à·„à¶½', flag: 'ğŸŒ' },
  { code: 'ln', name: 'Lingala', flag: 'ğŸŒ' },
  { code: 'bg', name: 'Ğ±ÑŠĞ»Ğ³Ğ°Ñ€ÑĞºĞ¸', flag: 'ğŸŒ' },
  { code: 'tr', name: 'TÃ¼rkÃ§e', flag: 'ğŸŒ' },
  { code: 'th', name: 'à¹„à¸—à¸¢', flag: 'ğŸŒ' },
  { code: 'mt', name: 'Malti', flag: 'ğŸŒ' },
  { code: 'hr', name: 'hrvatski', flag: 'ğŸŒ' },
  { code: 'fr', name: 'FranÃ§ais', flag: 'ğŸŒ' },
  { code: 'yo', name: 'YorÃ¹bÃ¡', flag: 'ğŸŒ' },
  { code: 'lv', name: 'latvieÅ¡u', flag: 'ğŸŒ' },
  { code: 'bem', name: 'Cibemba', flag: 'ğŸŒ' },
  { code: 'mk', name: 'Ğ¼Ğ°ĞºĞµĞ´Ğ¾Ğ½ÑĞºĞ¸', flag: 'ğŸŒ' },
  { code: 'sk', name: 'slovenÄina', flag: 'ğŸŒ' },
  { code: 'ss', name: 'SiSwati', flag: 'ğŸŒ' },
  { code: 'guc', name: 'Wayuunaiki', flag: 'ğŸŒ' },
  { code: 've', name: 'Luvenda', flag: 'ğŸŒ' },
  { code: 'pdt', name: 'Plautdietsch', flag: 'ğŸŒ' },
  { code: 'kl', name: 'Kalaallisut', flag: 'ğŸŒ' },
  { code: 'quy', name: 'Quechua (Ayacucho)', flag: 'ğŸŒ' },
  { code: 'sr-latn', name: 'srpski (latinica)', flag: 'ğŸŒ' },
  { code: 'he', name: '×¢×‘×¨×™×ª', flag: 'ğŸŒ' },
  { code: 'srn', name: 'Sranantongo', flag: 'ğŸŒ' },
  { code: 'quz', name: 'quechua (Cusco)', flag: 'ğŸŒ' },
  { code: 'mr', name: 'à¤®à¤°à¤¾à¤ à¥€', flag: 'ğŸŒ' },
  { code: 'bn', name: 'à¦¬à¦¾à¦‚à¦²à¦¾', flag: 'ğŸŒ' },
  { code: 'af', name: 'Afrikaans', flag: 'ğŸŒ' },
  { code: 'hi', name: 'à¤¹à¤¿à¤‚à¤¦à¥€', flag: 'ğŸŒ' },
  { code: 'pap', name: 'Papiamentu (KÃ²rsou)', flag: 'ğŸŒ' },
  { code: 'nr', name: 'IsiNdebele', flag: 'ğŸŒ' },
  { code: 'te', name: 'à°¤à±†à°²à±à°—à±', flag: 'ğŸŒ' },
  { code: 'qu', name: 'Quechua (Bolivia)', flag: 'ğŸŒ' },
  { code: 'fa', name: 'ÙØ§Ø±Ø³ÛŒ', flag: 'ğŸŒ' },
  { code: 'que', name: 'Quechua (Ancash)', flag: 'ğŸŒ' },
  { code: 'ug-cyrl', name: 'Ğ£Ğ¹Ò“ÑƒÑ€ (ĞºĞ¸Ñ€Ğ¸Ğ»Ğ» Ğ¹ĞµĞ·Ğ¸Ò“Ğ¸)', flag: 'ğŸŒ' },
  { code: 'ncj', name: 'nÃ¡huatl del norte de Puebla', flag: 'ğŸŒ' },
  { code: 'ach', name: 'Acholi', flag: 'ğŸŒ' },
  { code: 'lo', name: 'àº¥àº²àº§', flag: 'ğŸŒ' },
  { code: 'ay', name: 'Aymara', flag: 'ğŸŒ' },
  { code: 'fj', name: 'vakaViti', flag: 'ğŸŒ' },
  { code: 'uz-latn', name: 'oâ€˜zbekcha (lotincha)', flag: 'ğŸŒ' },
  { code: 'vmw', name: 'Emakhuwa', flag: 'ğŸŒ' },
  { code: 'seh', name: 'Cisena', flag: 'ğŸŒ' },
  { code: 'tpi', name: 'Tok Pisin', flag: 'ğŸŒ' },
  { code: 'mh', name: 'Kajin MÌ¦ajelÌ¦', flag: 'ğŸŒ' },
  { code: 'ee', name: 'EÊ‹egbe', flag: 'ğŸŒ' },
  { code: 'lgg', name: 'Lugbara', flag: 'ğŸŒ' },
  { code: 'wo', name: 'Wolof', flag: 'ğŸŒ' },
  { code: 'mn', name: 'Ğ¼Ğ¾Ğ½Ğ³Ğ¾Ğ»', flag: 'ğŸŒ' },
  { code: 'mfe', name: 'Kreol Morisien', flag: 'ğŸŒ' },
  { code: 'ada', name: 'Dangme', flag: 'ğŸŒ' },
  { code: 'pau', name: 'Palauan', flag: 'ğŸŒ' },
  { code: 'ht', name: 'KreyÃ²l ayisyen', flag: 'ğŸŒ' },
  { code: 'nzi', name: 'Nzema', flag: 'ğŸŒ' },
  { code: 'kwy', name: 'Kikongo', flag: 'ğŸŒ' },
  { code: 'gug', name: 'guarani', flag: 'ğŸŒ' },
  { code: 'sid', name: 'Sidaamu Afoo', flag: 'ğŸŒ' },
  { code: 'tg', name: 'Ñ‚Ğ¾Ò·Ğ¸ĞºÓ£', flag: 'ğŸŒ' },
  { code: 'om', name: 'Afaan Oromoo', flag: 'ğŸŒ' },
  { code: 'lg', name: 'Luganda', flag: 'ğŸŒ' },
  { code: 'kos', name: 'Kosraean', flag: 'ğŸŒ' },
  { code: 'zai', name: 'diidxazÃ¡', flag: 'ğŸŒ' },
  { code: 'pap-x-paa', name: 'Papiamento (Aruba)', flag: 'ğŸŒ' },
  { code: 'mos', name: 'Moore', flag: 'ğŸŒ' },
  { code: 'kk', name: 'Ò›Ğ°Ğ·Ğ°Ò›', flag: 'ğŸŒ' },
  { code: 'kab', name: 'Taqbaylit', flag: 'ğŸŒ' },
  { code: 'ngu', name: 'nÃ¡huatl de guerrero', flag: 'ğŸŒ' },
  { code: 'ho', name: 'Hiri Motu', flag: 'ğŸŒ' },
  { code: 'xmv', name: 'Tankarana', flag: 'ğŸŒ' },
  { code: 'to', name: 'Faka-Tonga', flag: 'ğŸŒ' },
  { code: 'umb', name: 'Umbundu', flag: 'ğŸŒ' },
  { code: 'quc', name: 'quichÃ©', flag: 'ğŸŒ' },
  { code: 'tk-cyrl', name: 'Ñ‚Ò¯Ñ€ĞºĞ¼ĞµĞ½ (ĞºĞ¸Ñ€Ğ¸Ğ»Ğ»Ğ¸Ñ†Ğ°)', flag: 'ğŸŒ' },
  { code: 'hmn', name: 'Hmoob Dawb', flag: 'ğŸŒ' },
  { code: 'nyn', name: 'Runyankore', flag: 'ğŸŒ' },
  { code: 'bi', name: 'Bislama', flag: 'ğŸŒ' },
  { code: 'cat', name: 'catalÃ ', flag: 'ğŸŒ' },
  { code: 'kmb', name: 'Kimbundu', flag: 'ğŸŒ' },
  { code: 'gil', name: 'Kiribati', flag: 'ğŸŒ' },
  { code: 'ngl', name: 'Elomwe', flag: 'ğŸŒ' },
  { code: 'kmr-cyrl', name: 'Ğšâ€²oÌˆÑ€Ğ´Ğ¸ ĞšoÌˆÑ€Ğ¼Ğ°Ğ½Ñ‰Ğ¸ (ĞšĞ¸Ñ€Ğ¸Ğ»Ğ¸)', flag: 'ğŸŒ' },
  { code: 'ki', name: 'GÄ©kÅ©yÅ©', flag: 'ğŸŒ' },
  { code: 'luo', name: 'Dholuo', flag: 'ğŸŒ' },
  { code: 'crs', name: 'Kreol Seselwa', flag: 'ğŸŒ' },
  { code: 'kam', name: 'Kikamba', flag: 'ğŸŒ' },
  { code: 'wls', name: 'Faka\'uvea', flag: 'ğŸŒ' },
  { code: 'tiv', name: 'Tiv', flag: 'ğŸŒ' },
  { code: 'ha', name: 'Hausa', flag: 'ğŸŒ' },
  { code: 'os', name: 'Ğ¸Ñ€Ğ¾Ğ½', flag: 'ğŸŒ' },
  { code: 'tdt', name: 'Tetun Dili', flag: 'ğŸŒ' },
  { code: 'yua', name: 'maaya', flag: 'ğŸŒ' },
  { code: 'pon', name: 'Lokaiahn Pohnpei', flag: 'ğŸŒ' },
  { code: 'hyw', name: 'Ô±Ö€Õ¥Ö‚Õ´Õ¿Õ¡Õ°Õ¡ÕµÕ¥Ö€Õ§Õ¶', flag: 'ğŸŒ' },
  { code: 'bm', name: 'Bamanankan', flag: 'ğŸŒ' },
  { code: 'tt', name: 'Ñ‚Ğ°Ñ‚Ğ°Ñ€', flag: 'ğŸŒ' },
  { code: 'teo', name: 'Ateso', flag: 'ğŸŒ' },
  { code: 'lu', name: 'Kiluba', flag: 'ğŸŒ' },
  { code: 'war', name: 'Waray-Waray', flag: 'ğŸŒ' },
  { code: 'pag', name: 'Pangasinan', flag: 'ğŸŒ' },
  { code: 'bcl', name: 'Bicol', flag: 'ğŸŒ' },
  { code: 'lua', name: 'Tshiluba', flag: 'ğŸŒ' },
  { code: 'rw', name: 'Ikinyarwanda', flag: 'ğŸŒ' },
  { code: 'kg', name: 'Kikongo (RÃ©p. dÃ©m. du congo)', flag: 'ğŸŒ' },
  { code: 'maz', name: 'jÃ±atrjo', flag: 'ğŸŒ' },
  { code: 'nv', name: 'DinÃ© Bizaad', flag: 'ğŸŒ' },
  { code: 'nch', name: 'nÃ¡huatl de la huasteca', flag: 'ğŸŒ' },
  { code: 'tog', name: 'Chitonga (Malawi)', flag: 'ğŸŒ' },
  { code: 'swc', name: 'Kiswahili (Congo)', flag: 'ğŸŒ' },
  { code: 'cy', name: 'Cymraeg', flag: 'ğŸŒ' },
  { code: 'am', name: 'áŠ áˆ›áˆ­áŠ›', flag: 'ğŸŒ' },
  { code: 'km', name: 'ááŸ’á˜áŸ‚áš', flag: 'ğŸŒ' },
  { code: 'kn', name: 'à²•à²¨à³à²¨à²¡', flag: 'ğŸŒ' },
  { code: 'my', name: 'á€™á€¼á€”á€ºá€™á€¬', flag: 'ğŸŒ' },
  { code: 'tn', name: 'Setswana', flag: 'ğŸŒ' },
  { code: 'toi', name: 'Chitonga', flag: 'ğŸŒ' },
  { code: 'rtm', name: 'Rotuáº¡m ta', flag: 'ğŸŒ' },
  { code: 'yap', name: 'Waab', flag: 'ğŸŒ' },
  { code: 'tyv', name: 'Ñ‚Ñ‹Ğ²Ğ°', flag: 'ğŸŒ' },
  { code: 'hz', name: 'Otjiherero', flag: 'ğŸŒ' },
  { code: 'as', name: 'à¦…à¦¸à¦®à§€à¦¯à¦¼à¦¾', flag: 'ğŸŒ' },
  { code: 'zne', name: 'Zande', flag: 'ğŸŒ' },
  { code: 'ttj', name: 'Rutoro', flag: 'ğŸŒ' },
  { code: 'tvl', name: 'Tuvalu', flag: 'ğŸŒ' },
  { code: 'ng', name: 'Oshindonga', flag: 'ğŸŒ' },
  { code: 'cv', name: 'Ñ‡Ó‘Ğ²Ğ°ÑˆĞ»Ğ°', flag: 'ğŸŒ' },
  { code: 'niu', name: 'Faka-Niue', flag: 'ğŸŒ' },
  { code: 'chk', name: 'Chuuk', flag: 'ğŸŒ' },
  { code: 'bin', name: 'Edo', flag: 'ğŸŒ' },
  { code: 'nd', name: 'Ndebele (Zimbabwe)', flag: 'ğŸŒ' },
  { code: 'bas', name: 'Basaa (Kamerun)', flag: 'ğŸŒ' },
  { code: 'gkn', name: 'Gokana', flag: 'ğŸŒ' },
  { code: 'dga', name: 'Dagaare', flag: 'ğŸŒ' },
  { code: 'bba', name: 'BaatÉ”num', flag: 'ğŸŒ' },
  { code: 'ckb', name: 'Ú©ÙˆØ±Ø¯ÛŒ Ø³Û†Ø±Ø§Ù†ÛŒ', flag: 'ğŸŒ' },
  { code: 'wal', name: 'Wolayttattuwa', flag: 'ğŸŒ' },
  { code: 'dua', name: 'Douala', flag: 'ğŸŒ' },
  { code: 'fon', name: 'FÉ”ngbe', flag: 'ğŸŒ' },
  { code: 'bum', name: 'Bulu', flag: 'ğŸŒ' },
  { code: 'nya', name: 'Cinyanja', flag: 'ğŸŒ' },
  { code: 'whg', name: 'Jiwaka Yu', flag: 'ğŸŒ' },
  { code: 'rmn-x-rm', name: 'romane (Makedonija)', flag: 'ğŸŒ' },
  { code: 'lb', name: 'LÃ«tzebuergesch', flag: 'ğŸŒ' },
  { code: 'kck-x-kl', name: 'Kalanga (Botswana)', flag: 'ğŸŒ' },
  { code: 'kbd', name: 'Ğ°Ğ´Ñ‹Ğ³ÑĞ±Ğ·Ñ', flag: 'ğŸŒ' },
  { code: 'mni', name: 'à¦®à§ˆà¦¤à§ˆà¦²à§‹à¦¨à§', flag: 'ğŸŒ' },
  { code: 'dyu', name: 'Jula', flag: 'ğŸŒ' },
  { code: 'os-x-dgr', name: 'Ğ´Ğ¸Ğ³Ğ¾Ñ€Ğ¾Ğ½', flag: 'ğŸŒ' },
  { code: 'gui', name: 'GuaranÃ­ boliviano', flag: 'ğŸŒ' },

  // --- JW.org Extended Languages (578 additional) ---
  { code: 'ab', name: 'Abkhazian', flag: 'ğŸŒ' },
  { code: 'fub', name: 'Adamawa Fulfulde', flag: 'ğŸŒ' },
  { code: 'aa', name: 'Afar', flag: 'ğŸŒ' },
  { code: 'agr', name: 'Aguaruna', flag: 'ğŸŒ' },
  { code: 'ake', name: 'Akawaio', flag: 'ğŸŒ' },
  { code: 'bss', name: 'Akoose', flag: 'ğŸŒ' },
  { code: 'alz', name: 'Alur', flag: 'ğŸŒ' },
  { code: 'amc', name: 'Amahuaca', flag: 'ğŸŒ' },
  { code: 'zpo', name: 'AmatlÃ¡n Zapotec', flag: 'ğŸŒ' },
  { code: 'qva', name: 'Ambo-Pasco Quechua', flag: 'ğŸŒ' },
  { code: 'ami', name: 'Amis', flag: 'ğŸŒ' },
  { code: 'grc', name: 'Ancient Greek', flag: 'ğŸŒ' },
  { code: 'yli', name: 'Angguruk Yali', flag: 'ğŸŒ' },
  { code: 'aui', name: 'Anuki', flag: 'ğŸŒ' },
  { code: 'ajg', name: 'Aja (Benin)', flag: 'ğŸŒ' },
  { code: 'aii', name: 'Assyrian Neo-Aramaic', flag: 'ğŸŒ' },
  { code: 'awa', name: 'Awadhi', flag: 'ğŸŒ' },
  { code: 'azb', name: 'South Azerbaijani', flag: 'ğŸŒ' },
  { code: 'kbr', name: 'Kafa', flag: 'ğŸŒ' },
  { code: 'shp', name: 'Shipibo-Conibo', flag: 'ğŸŒ' },
  { code: 'ura', name: 'Urarina', flag: 'ğŸŒ' },
  { code: 'sah', name: 'Yakut', flag: 'ğŸŒ' },
  { code: 'yaa', name: 'Yaminahua', flag: 'ğŸŒ' },
  { code: 'dje', name: 'Zarma', flag: 'ğŸŒ' },
  { code: 'zyp', name: 'Zhuang', flag: 'ğŸŒ' },
];

function init() {
    // Generate options including flags
    const opts = LANGUAGES.map(l => `<option value="${l.code}">${l.flag ? l.flag + ' ' : ''}${l.name}</option>`).join('');
    
    // Populate Source Language
    ui.srcLang.innerHTML = opts;
    
    // Populate Target Language (Exclude Auto Detect if desired, but keeping to match request for dynamic selection)
    // Note: Usually you translate TO a specific language, but we'll leave Auto as an option if the backend supports it or just let user choose.
    ui.tgtLang.innerHTML = opts;

    // Set Defaults
    ui.srcLang.value = "en-US";
    ui.tgtLang.value = "nl-BE"; // Default to Dutch BE
    
    populateDevices();
    initRecvViz();
}

init();
</script>
</body>
</html>