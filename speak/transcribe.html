<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Eburon Voice Translator</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />
  <style>
    :root{ --bg:#07090c; --good:#2ea043; --bad:#f85149; --text:#e6edf3; --muted:#9aa4af; }
    *{box-sizing:border-box; margin:0; padding:0;}
    body{ margin:0; overflow:hidden; background: var(--bg); color: var(--text); font-family: system-ui, -apple-system, sans-serif; }
    
    .mic-button {
      position: fixed; bottom: 20px; left: 20px; width: 80px; height: 80px; border-radius: 50%;
      background: linear-gradient(135deg, #2ea043, #1a7f37); border: none; cursor: pointer;
      display: flex; align-items: center; justify-content: center; z-index: 9999;
    }
    .mic-button.recording { background: linear-gradient(135deg, #f85149, #da3633); animation: pulse 1.5s infinite; }
    .mic-button span { color: white; font-size: 32px; }
    @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }

    .subtitle-container { position: fixed; bottom: 120px; left: 5%; right: 5%; display: flex; flex-direction: column; align-items: center; gap: 10px; pointer-events: none; }
    .subtitle-text, .translation-text { 
      background: rgba(13, 17, 23, 0.9); padding: 12px 24px; border-radius: 12px; 
      font-size: 18px; text-align: center; display: none; max-width: 90%;
    }
    .visible { display: block; }
    .translation-text { border: 1px solid #2ea043; color: #2ea043; }
    .subtitle-text { border: 1px solid #58a6ff; }

    .status-pill {
      position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
      display: flex; align-items: center; gap: 8px; padding: 10px 16px;
      border: 1px solid rgba(88, 166, 255, 0.2); border-radius: 999px;
      background: rgba(13, 17, 23, 0.85); font-size: 13px;
    }
    .status-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--muted); }
    .status-dot.good { background: var(--good); }
    .status-dot.bad { background: var(--bad); }
  </style>
</head>
<body>

  <div class="status-pill">
    <div class="status-dot" id="statusDot"></div>
    <span id="statusText">Ready</span>
  </div>

  <button class="mic-button" id="micBtn"><span class="material-symbols-outlined">mic</span></button>
  
  <div class="subtitle-container">
    <div class="translation-text" id="translationText"></div>
    <div class="subtitle-text" id="subtitleText"></div>
  </div>

<script>
(() => {
  // --- CONFIG ---
  const ORBIT_KEY = "5acf265560dee9b1da22fcad5791b9ea13efdd80";
  const ORBIT_TTS_KEY = "sk_car_JmdGRhBt1ocwhqmrxy2gaa"; // <--- Add your key
  const EBURON_AI_KEY = "4656c8aa48024789a93ff8d7e2916213.3UesBQT2hA-CQCVoWPtRqzYT"; // <--- Add from https://ollama.com/settings/keys
  const EBURON_AI_URL = "https://ollama.com/api/chat"; // Cloud API
  const TARGET_LANG = "Dutch (Flemish)";

  const micBtn = document.getElementById('micBtn');
  const subtitleEl = document.getElementById('subtitleText');
  const translationEl = document.getElementById('translationText');
  const statusDot = document.getElementById('statusDot');
  const statusText = document.getElementById('statusText');

  let isRecording = false;
  let socket, stream, recorder;

  function updateStatus(kind, msg) {
    statusDot.className = `status-dot ${kind}`;
    statusText.textContent = msg;
    console.log(`[Status] ${msg}`);
  }

  async function start() {
    try {
      stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      socket = new WebSocket("wss://api.deepgram.com/v1/listen?model=nova-2&smart_format=true", ["token", DEEPGRAM_KEY]);

      socket.onopen = () => {
        updateStatus("good", "Listening...");
        micBtn.classList.add("recording");
        recorder = new MediaRecorder(stream);
        recorder.ondataavailable = (e) => socket.readyState === 1 && socket.send(e.data);
        recorder.start(250);
      };

      socket.onmessage = async (msg) => {
        const data = JSON.parse(msg.data);
        const transcript = data.channel?.alternatives[0]?.transcript;
        if (!transcript) return;

        subtitleEl.textContent = transcript;
        subtitleEl.classList.add("visible");

        if (data.is_final) {
          await handleTranslation(transcript);
        }
      };

      socket.onerror = (e) => updateStatus("bad", "Orbit Error");
      isRecording = true;
    } catch (e) {
      updateStatus("bad", "Mic access denied");
    }
  }

  function stop() {
    isRecording = false;
    micBtn.classList.remove("recording");
    if (recorder) recorder.stop();
    if (socket) socket.close();
    updateStatus("", "Ready");
  }

  micBtn.onclick = () => isRecording ? stop() : start();

  // --- OLLAMA CLOUD TRANSLATION ---
  async function handleTranslation(text) {
    updateStatus("good", "Translating...");
    try {
      const resp = await fetch(EBURON_AI_URL, {
        method: "POST",
        headers: { 
          "Content-Type": "application/json",
          "Authorization": `Bearer ${EBURON_AI_KEY}`
        },
        body: JSON.stringify({
          model: "eburon-ai:cloud", // Eburon AI model
          messages: [{ role: "user", content: `Translate to ${TARGET_LANG}. Only output translation: "${text}"` }],
          stream: false
        })
      });

      if (!resp.ok) throw new Error("Eburon AI Cloud API failed. Check your API key.");
      
      const data = await resp.json();
      const translation = data.message.content.replace(/"/g, '').trim();
      
      translationEl.textContent = translation;
      translationEl.classList.add("visible");
      
      await playTTS(translation);
    } catch (e) {
      updateStatus("bad", e.message);
    }
  }

  // --- CARTESIA TTS ---
  async function playTTS(text) {
    updateStatus("good", "Generating Voice...");
    try {
      const response = await fetch("https://api.cartesia.ai/tts/bytes", {
        method: "POST",
        headers: {
          "Cartesia-Version": "2025-04-16",
          "X-API-Key": ORBIT_TTS_KEY,
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          model_id: "sonic-3-latest",
          transcript: text,
          voice: { mode: "id", id: "dda33d93-9f12-4a59-806e-a98279ebf050" },
          output_format: { container: "wav", encoding: "pcm_f32le", sample_rate: 44100 }
        })
      });

      if (!response.ok) throw new Error("Cartesia API Error");

      const blob = await response.blob();
      const url = URL.createObjectURL(blob);
      const audio = new Audio(url);
      audio.onplay = () => updateStatus("good", "Speaking...");
      audio.onended = () => updateStatus("good", "Listening...");
      await audio.play();
    } catch (e) {
      updateStatus("bad", "Orbit TTS Failed");
    }
  }
})();
</script>
</body>
</html>
